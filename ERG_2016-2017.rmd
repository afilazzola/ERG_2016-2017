---
title:
author: "fitz90"
date: "June 2016"
output:
  html_document:
    theme: yeti
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
---
###Ephedra regional gradient (ERG) analyses
An under-examined component of the shrub-annual relationship is how regional drivers, such as climate, may alter the sign or magnitude of positive interactions. Interspecific interactions between plants have been shown to be strongly linked to climate, particularly temperature and precipitation. The stress-gradient hypothesis (SGH) predicts that higher abiotic stress (i.e. for deserts, increasing temperature and reduced precipitation) will increase the frequency of positive interactions among shrubs and their annual understory. Regional climate gradients also have indirect effects on plant composition, such as determining consumer abundance and soil nutrient composition. Nutrient availability is particularly affected by precipitation because of altered decomposition rates of organic matter and mineralization. Therefore, the strength of facilitation and operating mechanism of a shrub on the annual plant community may change along a regional gradient. Within this experiment we test the hypothesis that positive interactions among shrubs and annual plants will increase with abiotic stress and reduce nutrient availability along a regional gradient of aridity.

![](./ephedra_cover.JPG)

[ecoblender](http://ecoblender.org)

[alex.filazzola](http://www.filazzola.info)


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load packages, echo=FALSE, warning=FALSE, message=FALSE}
## load packages for spatial manipulation
library(raster)
library(rgdal)
library(dismo)
library(rJava)
library(maptools)
library(rgeos)
library(ncdf4)
```

``` {r load functions, echo=FALSE}
error.bar <- function(x, y, upper, lower=upper, length=0,...){
if(length(x) != length(y) | length(y) !=length(lower) | length(lower) != length(upper))
stop("vectors must be same length")
arrows(x,y+upper, x, y-lower, angle=90, code=3, length=length, ...)
}

se <- function(x) sd(x)/sqrt(length(x)) ## standard error

get_cru <- function(lat, lon, variable, folder){ ##extract CRU data
  CRU <- file.path(folder, sprintf('cru_ts3.21.1901.2012.%s.dat.nc', variable))
  nc  <-  nc_open(CRU)
  lat.vals  <-    ncvar_get(nc,varid="lat")
  lon.vals    <-    ncvar_get(nc,varid="lon")
  days.since <- ncvar_get(nc,varid="time")
  start.time = 1
  
  lat.i  <-  which.min(abs(lat.vals-lat))[1]
  lon.i  <-  which.min(abs(lon.vals-lon))[1]
  
  vals = ncvar_get(nc=nc, varid=variable,start=c(lon.i,lat.i,start.time),count=c(1,1,length(days.since)))
  nc_close(nc)
  
  days.since = as.Date('1900-01-01')+days.since
  df <- data.frame("DateTime"=days.since,"vals"=vals)
  names(df)[2] <- variable
  return(df)
}
```

``` {r climate extraction, echo=FALSE, message=FALSE, warning=FALSE, fig.width=14, fig.height=8}
##input lat longs for each site. 
ID<-c(1,2,3,4,5,6,7)
site<-c("Panoche","Cuyama","TejonRanch","Barstow","MojavePreserve","SheepholeValley","Tecopa")
lat<-c(36.70000998,34.85521998,34.875994,35.094051,34.698199,34.205676,35.85151504)
lon<-c(-120.801116,-119.48851,-118.60246,-116.8349,-115.684169,-115.719676,-116.186706)

## assign as spatial data points
gps <- data.frame(x=lon,y=lat)
gps.sp <- data.frame(x=lon,y=lat)
crs.world <-CRS("+proj=longlat +datum=WGS84")
coordinates(gps.sp) <- ~x+y
proj4string(gps.sp) <- crs.world

##create empty data frame
climate.data <- data.frame(site=character(),DateTime=as.Date(character()),pre=character(),tmp=character(),pet=character())

##loop extraction of climate data (3 var) for each of the 7 sites.
## precipitation, temperature, potential evapotranspiration
for(i in 1:7){
precip.data <- get_cru(gps[i,"y"],gps[i,"x"], "pre", "C:\\Users\\Fitz\\Documents\\CRU data")
temp.data <- get_cru(gps[i,"y"],gps[i,"x"], "tmp", "C:\\Users\\Fitz\\Documents\\CRU data")
pet.data <- get_cru(gps[i,"y"],gps[i,"x"], "pet", "C:\\Users\\Fitz\\Documents\\CRU data")
site.name <- rep(paste("site",i),length(precip.data))
precip.data <- cbind(site.name,precip.data,temp=temp.data[,2],pet=pet.data[,2])
climate.data <- rbind(climate.data,precip.data)
}

## expand date into columns
datetxt <- climate.data[,"DateTime"]
date.columns <- data.frame(year = as.numeric(format(datetxt, format = "%Y")),month = as.numeric(format(datetxt, format = "%m")))

## add back to climate data
climate.data <- cbind(climate.data,date.columns)
climate.data[,"aridity"] <- climate.data[,"pre"]/(climate.data[,"temp"]+10)

means <- aggregate(climate.data, by=list(site.name=climate.data$site.name), mean)
ses <- aggregate(climate.data, by=list(site.name=climate.data$site.name), se)

## aridity of sites
xax <- seq(1,7,1)
par(mar=c(4.5,4.5,.5,.5))
plot(xax,means[,"aridity"], pch=19, cex=1.2, cex.axis=1.5, cex.lab=1.8, xlab="site", ylab="aridity", ylim=c(0,3.5), xaxt="n")
error.bar(xax,means[,"aridity"],ses[,"aridity"])
axis(1, xax, unique(site), cex.axis=1.3)

```

```{r soil analyses, echo=FALSE, warning=FALSE, message=FALSE, fig.width=10, fig.height=8}
## load data from analysis UC Davis - May 25
source('soil.analysis.data.R')
soil.data=soil.data

soil.mean <- aggregate(soil.data, by=list(site=soil.data$gradient,microsite=soil.data$microsite), mean)
soil.se <- aggregate(soil.data, by=list(site=soil.data$gradient,microsite=soil.data$microsite), se)


## plot nitrogen
plot(xax+0.1,soil.mean[8:14,"N"], pch=19, xlab="site", xaxt="n", ylab="Nitrogen (ppm)", ylim=c(0,40), cex.lab=1.7, xlim=c(0.8,7.2))
error.bar(xax+0.1,soil.mean[8:14,"N"],soil.se[8:14,"N"])
axis(1, xax, unique(site), cex.axis=1.3)
error.bar(xax-0.1,soil.mean[1:7,"N"],soil.se[1:7,"N"])
points(xax-0.1,soil.mean[1:7,"N"],pch=21, bg="white")

m1.s <- lm(N~gradient, data=soil.mean, microsite=="shrub")
m1.o <- lm(N~gradient, data=soil.mean, microsite=="open")
summary(m1.s)
summary(m1.o)

## plot phosphorus
plot(xax,soil.mean[8:14,"P"], pch=19, xlab="site", xaxt="n", ylab="Phosphorus (ppm)", ylim=c(0,20), cex.lab=1.7)
error.bar(xax,soil.mean[8:14,"P"],soil.se[8:14,"P"])
axis(1, xax, unique(site), cex.axis=1.3)
error.bar(xax-0.1,soil.mean[1:7,"P"],soil.se[1:7,"P"])
points(xax-0.1,soil.mean[1:7,"P"],pch=21, bg="white")

m2.s <- lm(P~gradient, data=soil.mean, microsite=="shrub")
m2.o <- lm(P~gradient, data=soil.mean, microsite=="open")
summary(m2.s)
summary(m2.o)

## plot potassium
plot(xax,soil.mean[8:14,"K"], pch=19, xlab="site", xaxt="n", ylab="Potassium (ppm)", ylim=c(50,600), cex.lab=1.7)
error.bar(xax,soil.mean[8:14,"K"],soil.se[8:14,"K"])
axis(1, xax, unique(site), cex.axis=1.3)
error.bar(xax-0.1,soil.mean[1:7,"K"],soil.se[1:7,"K"])
points(xax-0.1,soil.mean[1:7,"K"],pch=21, bg="white")

m3.s <- lm(K~gradient, data=soil.mean, microsite=="shrub")
m3.o <- lm(K~gradient, data=soil.mean, microsite=="open")
summary(m3.s)
summary(m3.o)
```