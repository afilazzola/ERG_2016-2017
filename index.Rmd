---
title: 'The effect of a dominant shrub on annuals plants in a desert system changes along a gradient of precipitation.'
author: "Alex Filazzola"
date: "May 2017"
output:
  html_document:
    theme: yeti
    toc: yes
    toc_depth: 3
    toc_float: yes
---
###Ephedra regional gradient (ERG) analyses

![](./ephedra_cover.JPG)

[ecoblender](http://ecoblender.org)

[alex.filazzola](http://www.filazzola.info)

#### Abstract

An under-examined component of the shrub-annual relationship is how regional drivers, such as climate, may alter the sign or magnitude of positive interactions. Interspecific interactions between plants have been shown to be strongly linked to climate, particularly temperature and precipitation. The stress-gradient hypothesis (SGH) predicts that higher abiotic stress (i.e. for deserts, increasing temperature and reduced precipitation) will increase the frequency of positive interactions among shrubs and their annual understory. Regional climate gradients also have indirect effects on plant composition, such as determining consumer abundance and soil nutrient composition. Nutrient availability is particularly affected by precipitation because of altered decomposition rates of organic matter and mineralization. Therefore, the strength of facilitation and operating mechanism of a shrub on the annual plant community may change along a regional gradient. 

#### Hypothesis

We tested the hypothesis that positive interactions among shrubs and annual plants will increase with abiotic stress and reduce nutrient availability along a regional gradient of aridity.

#### Methods

![](./ERGmethods.JPG)

```{r load packages, echo=FALSE, warning=FALSE, message=FALSE}
## load packages for spatial manipulation
library(raster)
library(rgdal)
library(dismo)
#library(rJava)
#library(maptools)
library(dplyr)
library(vegan)
library(MASS)
library(ggplot2)
library(tidyverse)
library(ggthemes)
```


``` {r load functions, echo=FALSE}
error.bar <- function(x, y, upper, lower=upper, length=0,...){
if(length(x) != length(y) | length(y) !=length(lower) | length(lower) != length(upper))
stop("vectors must be same length")
arrows(x,y+upper, x, y-lower, angle=90, code=3, length=length, ...)
}

se <- function(x) sd(x)/sqrt(length(x)) ## standard error

source("functions.r")
```

### Weather for growing season
```{r echo=FALSE, fid.width=28}

## weather station data

data <- read.table("Data/ERG.climatedata.csv", header=T,sep=",")
site.names <- c("Panoche","Cuyama","Tejon","Barstow","hwy40","Sheephole","Tecopa")
season1 <- subset(data, year==2015 & month > 10 | year==2016 & month < 5)
season2 <- subset(data, year==2016 & month > 10 | year==2017 & month < 5)
data <- rbind(season1,season2)
data[,"season"] <- c(rep("season.1",nrow(season1)),rep("season.2",nrow(season2)))
data <- na.omit(data)

means <- aggregate(data$avg.temp, by=list(data$season,data$Gradient), mean)
means.se <- aggregate(data$avg.temp, by=list(data$season,data$Gradient), se)
means[,"se"] <- means.se[,3]
colnames(means) <- c("season","gradient","avg","se")
means[,"upper"] <- means[,"avg"]+means[,"se"]*1.96
means[,"lower"] <- means[,"avg"]-means[,"se"]*1.96

q <- ggplot(means, aes(x=gradient, y=avg, ymin=lower, ymax=upper, fill=season)) +  geom_pointrange( position=position_dodge(width=0.4), color = rep(c("Grey50","Black"),7), size=1)+ guides(fill = "none") + scale_fill_manual(values = c("Black","Grey50"))+ scale_x_discrete(limits=c("Panoche","Cuyama","Tejon","Barstow","hwy40","Sheephole","Tecopa")) + scale_y_continuous(expand = c(0, 0)) + ylab("Average Temperature (C°)") + theme_Publication()
q

#precipitation
precip <- aggregate(data$Precip, by=list(data$season,data$Gradient), sum)
colnames(precip) <- c("season","Gradient","Precip")

p <-ggplot(precip, aes(Gradient, Precip, fill=season)) +geom_bar(stat = "identity", aes(fill = season), position = "dodge")+ scale_fill_manual(values = c("Black","Grey50"))+ scale_x_discrete(limits=c("Panoche","Cuyama","Tejon","Barstow","hwy40","Sheephole","Tecopa")) + scale_y_continuous(expand = c(0, 0))+ylab("Precipitation (mm)") + theme_Publication()+ guides(fill = "none") 
p


```

### Microenvironmental differences

We compared temperature and relative humidity between shrub and open microsites among all sites along the regional gradient
```{r echo=FALSE, warning=FALSE, message=FALSE, fig.width=18, fig.height=8, comment=NA}
HOBO.data <- read.csv("Data/ERG.logger.data.csv")
sites <- as.character(unique(HOBO.data$Site))
psuedograd <- c(2,4,5,1,6,7,3)

for(i in 1:7){
  HOBO.data[grep(sites[i], as.character(HOBO.data$Site)), "gradient"] <- psuedograd[i]
}

## daily means
day.mean <- aggregate(HOBO.data, by=list(day=HOBO.data$Day, micro=HOBO.data$Microsite, site=HOBO.data$Site), mean)

## summarize daily means across sites
means <- day.mean %>% group_by(micro, gradient) %>% summarize(temp=mean(Temp),rh=mean(RH),temp.se=se(Temp),rh.se=se(RH))
means <- data.frame(means)

par(mar=c(4.5,4.5,.5,.5))


site.name <- sites[order(psuedograd)]


par(mfrow=c(1,2))
## plot temperature
plot(c(1:7)-0.1, means[means$micro=="shrub","temp"], pch=19, ylim=c(5,15), xlab="", xaxt="n", ylab="temperature (C°)", cex.axis=1.3, cex.lab=1.5, cex=1.5, xlim=c(0.7,7.3))
axis(1, c(1:7), site.name, cex.axis=1.2)
error.bar(c(1:7)-0.1, means[means$micro=="shrub","temp"],means[means$micro=="shrub","temp.se"]*2, lwd=2)
error.bar(c(1:7)+0.1, means[means$micro=="open","temp"],means[means$micro=="open","temp.se"]*2, lwd=2)
points(c(1:7)+0.1, means[means$micro=="open","temp"], pch=21, bg="White", cex=1.5)

## plot relative humidity
plot(c(1:7)-0.1, means[means$micro=="shrub","rh"], pch=19, ylim=c(30,100), xlab="", xaxt="n", ylab="relative humidity (%)", cex.axis=1.3, cex.lab=1.5, cex=1.5, xlim=c(0.7,7.3))
axis(1, c(1:7), site.name, cex.axis=1.2)
error.bar(c(1:7)-0.1, means[means$micro=="shrub","rh"],means[means$micro=="shrub","rh.se"]*2, lwd=2)
error.bar(c(1:7)+0.1, means[means$micro=="open","rh"],means[means$micro=="open","rh.se"]*2, lwd=2)
points( c(1:7)+0.1, means[means$micro=="open","rh"], pch=21, bg="White", cex=1.5)
legend(5.8,100, c("shrub","open"), pch=21, pt.bg=c("black","white"), bty="n", cex=2)

## stats for temperature
day.mean[,"gradient"] <- as.factor(day.mean$gradient)
fit1 <- aov(log(Temp) ~ micro * gradient, data=day.mean)
shapiro.test(fit1$residuals) ## check normality
summary(fit1)

## stats for relative humidity
fit2 <- glm(RH/100 ~ micro * gradient, data=day.mean, family=binomial)
anova(fit2, test="Chisq")

## stats for soil moisture
census <- read.csv("Data/ERG.phytometer.census.csv")

## soil moisture differences 2016
swc2016 <- glm(swc ~ Site * Microsite, data=subset(census, Census=="emergence" & swc>0 & Year==2016), family="Gamma")
anova(swc2016, test="F")

## soil moisture differences 2017
swc2017 <- glm(swc ~ Site * Microsite, data=subset(census, Census=="emergence" & swc>0 & Year==2017), family="Gamma")
anova(swc2017, test="F")

ggplot(census) + geom_boxplot(aes(x=Site, y= swc, fill=Microsite))  + facet_grid(~Year) +
  scale_fill_brewer() +ylab("Soil Moisture COntent (%)")+ theme_Publication()
```


### site level means
```{r warning=FALSE, message=FALSE, fig.width=8, fig.height=8}
## long term climate data extracted from worldclim
site.gps <- read.csv("Data/ERGsites.csv")

clim.dat <- read.csv("Data/ERG.worldclim.csv")
## check correlation among long-term climate variables
cor(clim.dat[,3:8]) ## Temp.wettest.QR least correlated 

## Obtain mean weather variables for each site
weather <- read.csv("Data/ERG.climatedata.csv")

weather.mean <- weather %>% group_by(Gradient,Site) %>% summarise_all(funs(mean), na.rm=T)
weather.mean <- data.frame(weather.mean)
## extract key variables
weather.vars <- weather.mean[,c("Site","Gradient","avg.temp","Precip")]

##check for colineararity
cor(weather.vars[,3:5])

## Obtain mean nutrient variables for each site
nutrients <- read.csv("Data/ERG.soilnutrients.csv")
nutrients.mean <- nutrients %>% group_by(gradient,site) %>% summarise_all(funs(mean))
nutrients.vars <- data.frame(nutrients.mean)

## Obtain mean shrub traits for each site
shrubs <- read.csv("Data/ERG.shrub.csv")
shrubs <- subset(shrubs, Microsite=="shrub")
shrubs.mean <- shrubs %>% group_by(Gradient,Site) %>% summarise_all(funs(mean))
shrubs.mean <- data.frame(shrubs.mean)
shrubs.vars <- shrubs.mean[,c("Site","Gradient","volume","canopy","Dx","DxEph","Compaction")] 

##combine nutrients, weather, and shrub traits

site.vars <- data.frame(weather.vars[,3:4],nutrients.vars[,c("N","K")])
row.names(site.vars) <- weather.vars[,1]
site.vars[,"elevation"] <- site.gps[,"elevation"]
cor(site.vars) ##check for correlation among variables, removed worldclim vars, other weather station data, and Phosphorus

## PCA of site characteristics

pca1 <- prcomp(log(site.vars), scale=T)
plot(pca1)
biplot(pca1, scale = T)
summary(pca1) ## 87% variation explained

## Extract PCA1 loadings for gradient. Negative values precipitation, postive nitrogen and avg.temp
gradient.pca1 <- pca1$x[,1]
gradient.pca2 <- pca1$x[,2]

## PCA of shrub characteristics

row.names(shrubs.vars) <- shrubs.vars[,1]
pca2 <- prcomp(log(shrubs.vars[,3:7]))
plot(pca2)
biplot(pca2)


## season1
season1.mean <- season1 %>% group_by(Gradient,Site) %>% summarise(min.temp=mean(min.temp, na.rm=T),Precip=sum(Precip))
season1.mean  <- data.frame(season1.mean )
## extract key variables
## dropped RH, and chose min.temp because least correlation with others & cold stress

##combine nutrients and long-term averages
site.vars <- data.frame(season1.vars[,3:4],nutrients.vars[c("N","K")],clim.dat["Temp.Seasonality"],site.gps["elevation"]) ## drop Phosphorus and other climate variables because of correlations, 
row.names(site.vars) <- weather.vars[,1]
cor(site.vars)
site.vars2016 <- site.vars

pca1 <- prcomp(log(abs(site.vars)), scale=T)
plot(pca1)
biplot(pca1)
summary(pca1) ## 85% variation explained
gradient1.season1 <- pca1$x[,1]
gradient2.season1 <- pca1$x[,2]

## season2
season2.mean <- season2 %>% group_by(Gradient,Site) %>% summarise(min.temp=mean(min.temp, na.rm=T),Precip=sum(Precip))
season2.mean  <- data.frame(season2.mean )
## extract key variables
## dropped RH, and chose min.temp because least correlation with others & cold stress

##combine nutrients and long-term averages
site.vars <- data.frame(season2.vars[,3:4],nutrients.vars[c("N","K")],clim.dat["Temp.Seasonality"],site.gps["elevation"]) ## drop Phosphorus and other climate variables because of correlations, 
row.names(site.vars) <- weather.vars[,1]
cor(site.vars)
site.vars2017 <- site.vars

pca2 <- prcomp(log(abs(site.vars)), scale=T)
plot(pca2)
biplot(pca2)
summary(pca2) ## 84% variation explained
gradient1.season2 <- pca2$x[,1]
gradient2.season2 <- pca2$x[,2]
```

### Differences from Nutrient content
```{r}
## Nitrogen difference between shrub and sites
m.nit <- aov(log(N) ~ site * microsite, data=nutrients)
summary(m.nit)
TukeyHSD(m.nit, "microsite")

## Potassium difference between shrub and sites
m.pot <- aov(log(K) ~ site * microsite, data=nutrients)
summary(m.pot)
TukeyHSD(m.pot, "microsite")

## Phosphorus difference between shrub and sites
m.pho <- aov(log(P) ~ site * microsite, data=nutrients)
summary(m.pho)
TukeyHSD(m.pho, "microsite")
```

### annual plant community repsonse

```{r}
spp.data  <- read.csv("Data/ERG.communitydata.csv")
spp.data[is.na(spp.data)] <- 0

mean.spp <- spp.data %>% group_by(Year,Site) %>%  summarize(abd=mean(Abundance), richness=mean(Richness), biomass=mean(Biomass))
mean.spp <- data.frame(mean.spp)

## sort to gradient from alphabetical
alpha.grad <- c(4,2,5,1,6,7,3)
mean.spp2016 <- subset(mean.spp, Year==2016)
mean.spp2016  <-mean.spp[order(alpha.grad),]

## community responses 
plot(gradient1.season1, mean.spp2016[,"richness"]) ## explains trends with one outlier
m1 <- lm(richness~gradient1.season1, data=mean.spp2016)
summary(m1)

plot(gradient1.season1, mean.spp2016[,"abd"]) ## explains trends with one outlier
m2 <- lm(abd~gradient1.season1, data=mean.spp2016) ## trend
summary(m2)

plot(gradient2.season1, mean.spp2016[,"biomass"]) ## explains trends with one outlier
m3 <- lm(biomass~gradient1.season1, data=mean.spp2016) ## trend
summary(m3)

##season2
## sort to gradient from alphabetical
alpha.grad <- c(4,2,5,1,6,7,3)
mean.spp <- subset(mean.spp, Year==2017)
mean.spp  <-mean.spp[order(alpha.grad),]

## community responses season2
plot(gradient2.season2, mean.spp[,"richness"]) ## explains trends with one outlier
m1 <- lm(richness~gradient1.season2, data=mean.spp)
summary(m1)

plot(gradient1.season2, mean.spp[,"abd"]) ## explains trends with one outlier
m2 <- lm(abd~gradient1.season2, data=mean.spp) ## trend
summary(m2)

plot(gradient1.season2, mean.spp[,"biomass"]) ## explains trends with one outlier
m3 <- lm(biomass~gradient1.season2, data=mean.spp) ## trend
summary(m3)
```

### RDA community and environmental data
```{r}

community <- read.csv("Data/ERG.communitydata.csv")
community[is.na(community)] <- 0

##2016
## add enviro data to dataframe
comm2016 <- subset(community, Year==2016)
site.vars2016[,"Site"] <- as.factor(row.names(site.vars2016))
comm2016 <- merge(comm2016, site.vars2016, by="Site")

## transform spp data
community.trans <- decostand(comm2016[,13:53], "hellinger")

rda1 <- rda(community.trans, comm2016[,54:59])
(R2adj <- RsquareAdj(rda1)$adj.r.squared) ## 50.4% of variation explained


## build byplot manually
par(mar=c(4.5,4.5,0.5,0.5))
plot(rda1, type="n", xlim=c(-1,1), ylim=c(-1.5,1.5))

## calculate priority
spp.priority <- colSums(comm2016[,13:53])

## plot RDA1
colvec <- rep(c("blue","dodgerblue3","cyan","yellow2","orange","tomato","red2"),each=60)
points(rda1, display = "sites", col = "black", pch = c(21), bg = colvec)
orditorp(rda1, display = "species", cex = 0.7, col = "darkred", priority=spp.priority, air=0.5)
text(rda1,  display = "bp", col = "blue", cex = 0.8) 
legend("bottomright", pch=c(21), legend=unique(comm2016$Site), pt.bg=unique(colvec), cex=1)
## ordikplot to adjust species locations

## 2017
## add enviro data to dataframe
comm2017 <- subset(community, Year==2017)
site.vars[,"Site"] <- as.factor(row.names(site.vars))
comm2017 <- merge(comm2017, site.vars, by="Site")

## transform spp data
community.trans <- decostand(comm2017[,13:53], "hellinger")

rda2 <- rda(community.trans, comm2017[,54:59])
(R2adj <- RsquareAdj(rda2)$adj.r.squared) ## 50.4% of variation explained


## build byplot manually
par(mar=c(4.5,4.5,0.5,0.5))
plot(rda2, type="n", xlim=c(-1,1), ylim=c(-1.5,1.5))

## calculate priority
spp.priority <- colSums(comm2017[,13:53])

## plot RDA2
colvec <- rep(c("blue","dodgerblue3","cyan","yellow2","orange","tomato","red2"),each=60)
points(rda2, display = "sites", col = "black", pch = c(21), bg = colvec)
orditorp(rda2, display = "species", cex = 0.7, col = "darkred", priority=spp.priority, air=0.5)
text(rda2,  display = "bp", col = "blue", cex = 0.8) 
legend("bottomright", pch=c(21), legend=unique(comm2016$Site), pt.bg=unique(colvec), cex=1)
## ordikplot to adjust species locations

```

## Phytometer analysis
```{r warning=FALSE, message=FALSE}

census <- read.csv("Data/ERG.phytometer.census.csv")
census[is.na(census)] <- 0
census[,"phyto.abd"] <- rowSums(census[,c("Phacelia","Plantago","Salvia")])

## calculate the number of seeds per gram
seed.mass <- read.csv("Data/seed.mass.csv")
seed.mass.avg <- seed.mass %>% group_by(species) %>%  summarize(avg.seed.gram=mean(seed.number),se.seed.gram=se(seed.number))
seed.mass.avg <- data.frame(seed.mass.avg)
seed.mass.avg

## get proportion of seed germinated per 0.3 grams of seed
census[,"Phacelia.prop"] <- census[,"Phacelia"]/(seed.mass.avg$avg.seed.gram[which(seed.mass.avg$species=="Phacelia")]*0.3)
census[,"Plantago.prop"] <- census[,"Plantago"]/(seed.mass.avg$avg.seed.gram[which(seed.mass.avg$species=="Plantago")]*0.3)
census[,"Salvia.prop"] <- census[,"Salvia"]/(seed.mass.avg$avg.seed.gram[which(seed.mass.avg$species=="Salvia")]*0.3)


## beginning
census.int <- subset(census, Census=="emergence")

## all species
m1 <- glm.nb(Phacelia~ Microsite * Nutrient * Site + Year, data=census.int)
anova(m1, test="Chisq") ## Site * Micro and Year significant

## Phacelia
m1 <- glm.nb(Phacelia~ Microsite * Nutrient * Site + Year, data=census.int)
anova(m1, test="Chisq") ## Site * Micro and Year significant
## Plantago
m2 <- glm.nb(Plantago~ Microsite * Nutrient * Site + Year, data=census.int)
anova(m2, test="Chisq") ## Site * Micro and Year significant
## Salvia
m3 <- glm.nb(Salvia~ Microsite * Nutrient * Site + Year, data=census.int)
anova(m3, test="Chisq") ## Site * Micro and Year significant + (micro x nutrient)

census.int.plot <- gather(census.int, species, abundance, Phacelia:Salvia)

##calculate confidence interval
census.plot<- census.int.plot %>%  group_by(Microsite, species, Site) %>%  summarize(avg=mean(abundance),ci=se(abundance)*1.96)

ggplot(census.plot, aes(x=Microsite, y=avg, fill=species))+
  geom_bar(position=position_dodge(), stat="identity")+
   geom_errorbar(aes(ymin=avg-ci, ymax=avg+ci),
                  width=.2,                    # Width of the error bars
                  position=position_dodge(.9))+ scale_fill_brewer() +ylab("Abundance")+ theme_Publication() + facet_grid(~Site) 

## end season
census.end <- subset(census, Census=="end")

## run full model for phyto biomass
m1 <- aov(log(phyto.biomass)~ Site * Microsite * Nutrient + Year, data=subset(census.end, phyto.biomass>0))
summary(m1)
TukeyHSD(m1, "Microsite")

## all species end of season
m2 <- glm.nb(phyto.abd~ Microsite * Nutrient * Site + Year, data=census.end)
anova(m2, test="Chisq") ## Site and microsite*nutrient significant

## run full model for phacelia biomass
m3 <- aov(log(Phacelia)~ Site * Microsite * Nutrient + Year, data=subset(census.end, Phacelia>0))
summary(m3) ## site and microsite
TukeyHSD(m3, "Microsite")


## run full model for plantago biomass
m4 <- aov(log(Plantago)~ Site * Microsite * Nutrient + Year, data=subset(census.end, Plantago>0))
summary(m4) ## site and year + sitexmicrosite
TukeyHSD(m4, "Microsite")

```


```{r}
### RDA

##collect environmental variables for site
nutrients <- read.csv("Data/ERG.soilnutrients.csv")
nutrients.mean <- nutrients %>% group_by(gradient,site, microsite) %>% summarise_each(funs(mean))
nutrients.vars <- data.frame(nutrients.mean)

## minimum explanation of variables
ambient2016[is.na(ambient2016)] <- 0
community <- ambient2016 %>% group_by(Gradient,Site, Microsite) %>% summarise_each(funs(sum))
community <- data.frame(community)

end.census <- subset(census2016, census=="end")
end.census  <- end.census  %>% group_by(Gradient,Site, Microsite) %>% summarise_each(funs(mean))
end.census<- data.frame(end.census)

## daily means
day.mean <- aggregate(HOBO.data, by=list(day=HOBO.data$Day, micro=HOBO.data$Microsite, site=HOBO.data$Site), mean)

## summarize daily means across sites
means <- day.mean %>% group_by(gradient, micro) %>% summarize(temp=mean(Temp),rh=mean(RH),temp.se=se(Temp),rh.se=se(RH))
means <- data.frame(means)


envs <- data.frame(swc=end.census[,"swc"],nutrients.vars[,c("N","P","K")], means[,c("temp","rh")])

## hellinger transformation
community.trans <- decostand(community[,12:42], "hellinger")

## rda with environmental variables
rda1 <- rda(community.trans, envs)
anova(rda1)
(R2adj <- RsquareAdj(rda1)$adj.r.squared) ## 25.7% of variation explained


## build byplot manually
par(mar=c(4.5,4.5,0.5,0.5))
plot(rda1, type="n", xlim=c(-1,1))

with(community, levels(Site))

spp.priority <- colSums(community[,12:42])

colvec <- c("blue","dodgerblue3","cyan","yellow2","orange","tomato","red2")
with(community, points(rda1, display = "sites", col = "black", pch = c(21,22), bg = colvec[Site]))
orditorp(rda1, display = "species", cex = 0.7, col = "darkred", priority=spp.priority, air=1,)
text(rda1,  display = "bp", col = "blue", cex = 0.8) 
legend("bottomright", pch=c(21), legend=community$Site[community$Microsite=="shrub"], pt.bg=colvec, cex=1)

## check variable explanation
vif.cca(rda1)

v.clim <- cbind(envs[,c("temp","rh")])
v.nut <- cbind(envs[,c("N","P","K")])
v.swc <- envs[,"swc"]

x <- varpart(community.trans,v.clim,v.nut,v.swc)

showvarparts(3)
```


Difference in effect size

```{r warning=FALSE, fig.width=9}

library(bootES)

effect.cal <- function(x){ bootES(x, R=999, data.col="Biomass", group.col="Microsite", contrast=c(shrub=1,open=-1), effect.type=c("cohens.d"))}

effect.site <- by(subset(ambient2016, Site != "Barstow"), ambient2016$Site[ambient2016$Site != "Barstow"], FUN=effect.cal)

site.summary <- rbind(summary(effect.site$Panoche),summary(effect.site$Cuyama),summary(effect.site$TejonRanch),data.frame(stat=0,ci.low=0,ci.high=0,bias=0,std.error=0),summary(effect.site$MojavePreserve),summary(effect.site$SheepholeValley),summary(effect.site$Tecopa)) 


par(mar=c(4.5,4.5,.5,.5))
plot(c(1:7),site.summary[,"stat"], xlim=c(0.5,7.5), ylim=c(-1,3), pch=19, cex=1.4, ylab="Hedge's G", xlab="", xaxt="n")
arrows(c(1:7),site.summary[,"ci.high"],c(1:7),site.summary[,"ci.low"], angle=90, code=3, length=0, lwd=2)
abline(h=0, lty=2, lwd=2)
axis(1, c(1:7), labels=site.names, cex.axis=1)

## phytometer

effect.cal <- function(x){ bootES(x, R=999, data.col="phyto.biomass", group.col="Microsite", contrast=c(shrub=1,open=-1), effect.type=c("cohens.d"))}

census2016 <- subset(census2016, census=="end")

effect.site <- by(subset(census2016, Site != "Barstow"), census2016$Site[census2016$Site != "Barstow"], FUN=effect.cal)

site.summary <- rbind(summary(effect.site$Panoche),summary(effect.site$Cuyama),summary(effect.site$TejonRanch),data.frame(stat=0,ci.low=0,ci.high=0,bias=0,std.error=0),summary(effect.site$MojavePreserve),summary(effect.site$SheepholeValley),summary(effect.site$Tecopa)) 


par(mar=c(4.5,4.5,.5,.5))
plot(c(1:7),site.summary[,"stat"], xlim=c(0.5,7.5), ylim=c(-1,3), pch=19, cex=1.4, ylab="Hedge's G", xlab="", xaxt="n")
arrows(c(1:7),site.summary[,"ci.high"],c(1:7),site.summary[,"ci.low"], angle=90, code=3, length=0, lwd=2)
abline(h=0, lty=2, lwd=2)
axis(1, c(1:7), labels=site.names, cex.axis=1)
```

### Rii between years
```{r}

rii <- function(x, j, var)
{
s1 <- subset(x, Microsite == "shrub", select=var)
o1 <- subset(x, Microsite == "open", select=var)
return1 <- (s1 - o1) / (s1+o1)
x1 <- x[seq(1, nrow(x), by = 2),]
return2 <- cbind(x1[j], return1)
return2[is.na(return2)] <- 0
print(return2)
}


rii.dat <- rii(community, j=1:8, var=c("Abundance","Richness","Biomass"))

rii.mean <- rii.dat %>% group_by(Year, Gradient, Site) %>% summarize(avg=mean(Biomass),se=se(Biomass))
rii.mean <- data.frame(rii.mean)

plot(rii.mean[rii.mean$Year==2016,"Gradient"]-.1,rii.mean[rii.mean$Year==2016,"avg"], ylim=c(-1,1), pch=19, cex=1.5, xlim=c(0.5,7.5), ylab="Rii Biomass", xlab="Site", xaxt="n", cex.lab=1.5)
axis(1, 1:7, lab=unique(rii.mean$Site))
error.bar(rii.mean[rii.mean$Year==2016,"Gradient"]-.1,rii.mean[rii.mean$Year==2016,"avg"],rii.mean[rii.mean$Year==2016,"se"])
error.bar(rii.mean[rii.mean$Year==2017,"Gradient"]+.1,rii.mean[rii.mean$Year==2017,"avg"],rii.mean[rii.mean$Year==2017,"se"])
points(rii.mean[rii.mean$Year==2017,"Gradient"]+.1,rii.mean[rii.mean$Year==2017,"avg"], pch=21, bg="Grey50", cex=1.5)
abline(h=0, lwd=2, lty=2)
legend(6.6,-0.65, c("2016","2017"), pch=22, pt.bg=c("Black","Grey50"), cex=1.6)