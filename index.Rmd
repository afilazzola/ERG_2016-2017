---
title: 'The effect of a dominant shrub on annuals plants in a desert system changes along a gradient of precipitation.'
author: "Alex Filazzola"
date: "May 2017"
output:
  html_document:
    theme: yeti
    toc: yes
    toc_float: yes
    toc_depth: 3
  
---
###Ephedra regional gradient (ERG) analyses

![](./ephedra_cover.JPG)

[ecoblender](http://ecoblender.org)

[alex.filazzola](http://www.filazzola.info)

#### Abstract

An under-examined component of the shrub-annual relationship is how regional drivers, such as climate, may alter the sign or magnitude of positive interactions. Interspecific interactions between plants have been shown to be strongly linked to climate, particularly temperature and precipitation. The stress-gradient hypothesis (SGH) predicts that higher abiotic stress (i.e. for deserts, increasing temperature and reduced precipitation) will increase the frequency of positive interactions among shrubs and their annual understory. Regional climate gradients also have indirect effects on plant composition, such as determining consumer abundance and soil nutrient composition. Nutrient availability is particularly affected by precipitation because of altered decomposition rates of organic matter and mineralization. Therefore, the strength of facilitation and operating mechanism of a shrub on the annual plant community may change along a regional gradient. 

#### Hypothesis

We tested the hypothesis that positive interactions among shrubs and annual plants will increase with abiotic stress and reduce nutrient availability along a regional gradient of aridity.

#### Methods

![](./ERGmethods.JPG)

```{r load packages, echo=FALSE, warning=FALSE, message=FALSE}
## load packages for spatial manipulation
library(vegan)
library(MASS)
library(tidyverse)
library(ggthemes)
library(usdm)
library(broom)
require(gridExtra)
library(lme4)
library(lmerTest) ## approximations for tests
library(MuMIn) ## calculates R squared
library(lmPerm)
```


``` {r load functions, echo=FALSE}
error.bar <- function(x, y, upper, lower=upper, length=0,...){
if(length(x) != length(y) | length(y) !=length(lower) | length(lower) != length(upper))
stop("vectors must be same length")
arrows(x,y+upper, x, y-lower, angle=90, code=3, length=length, ...)
}

se <- function(x, ...) sd(x)/sqrt(length(x)) ## standard error

source("functions.r")

## inverse hyperbolic sine transformation for zero laden data that fits log transformations
##Zhang, M., Fortney, J. C., Tilford, J. M., & Rost, K. M. (2000). An application of the inverse hyperbolic sine transformation—a note. Health Services and Outcomes Research Methodology, 1(2), 165-171.
ihs <- function(x) {
    y <- log(x + sqrt(x ^ 2 + 1))
    return(y)
}

## reverse inverse hyperbolic sine
hs <- function(x) {
    y <- 0.5*exp(-x)*(exp(2*x)-1)
    return(y)
}


rii <- function(x, j, var)
{
s1 <- subset(x, Microsite == "shrub", select=var)
o1 <- subset(x, Microsite == "open", select=var)
return1 <- (s1 - o1) / (s1+o1)
x1 <- x[seq(1, nrow(x), by = 2),]
return2 <- cbind(x1[j], return1)
return2[is.na(return2)] <- 0
return(return2)
}
```


### load GAMs Gradient
```{r}
Year<-c("2016","2016","2016","2016","2016","2016","2016","2017","2017","2017","2017","2017","2017","2017")
Site<-c("Barstow","Cuyama","HeartofMojave","PanocheHills","SheepholeValley","Tecopa","TejonRanch","Barstow","Cuyama","HeartofMojave","PanocheHills","SheepholeValley","Tecopa","TejonRanch")
gamsq <-c(7992.36,6789.76,7903.21,5715.36,7779.24,7482.25,7447.69,6872.41,5882.89,7157.16,5595.04,7293.16,7106.49,6955.56)
gams.richard <-c(89.4,82.4,88.9,75.6,88.2,86.5,86.3,82.9,76.7,84.6,74.8,85.4,84.3,83.4)
gams <- c(89.6,71,84.7,62.7,88.3,80.6,80.7,63.6,51.4,73.4,49.5,69.4,68.3,65.8)

gams.data <- data.frame(Year,Site,gamsq,gams)


```

### Weather for growing season
```{r echo=FALSE, fid.width=28, warning=FALSE, message=FALSE}

## weather station data

data <- read.table("Data/ERG.climatedata.csv", header=T,sep=",")
site.names <- c("Panoche","Cuyama","Tejon","Barstow","hwy40","Sheephole","Tecopa")
season1 <- subset(data, year==2015 & month > 10 | year==2016 & month < 5)
season2 <- subset(data, year==2016 & month > 10 | year==2017 & month < 5)
data <- rbind(season1,season2)
data[,"season"] <- c(rep("season.1",nrow(season1)),rep("season.2",nrow(season2)))
data <- na.omit(data)

means <- aggregate(data$avg.temp, by=list(data$season,data$Gradient), mean)
means.se <- aggregate(data$avg.temp, by=list(data$season,data$Gradient), se)
means[,"se"] <- means.se[,3]
colnames(means) <- c("season","gradient","avg","se")
means[,"upper"] <- means[,"avg"]+means[,"se"]*1.96
means[,"lower"] <- means[,"avg"]-means[,"se"]*1.96

q <- ggplot(means, aes(x=gradient, y=avg, ymin=lower, ymax=upper, fill=season)) +  geom_pointrange( position=position_dodge(width=0.4), color = rep(c("Grey50","Black"),7), size=1)+ guides(fill = "none") + scale_fill_manual(values = c("Black","Grey50"))+ scale_x_discrete(limits=c("Panoche","Cuyama","Tejon","Barstow","hwy40","Sheephole","Tecopa")) + scale_y_continuous(expand = c(0, 0)) + ylab("Average Temperature (C°)") + theme_Publication()
q

#precipitation
precip <- aggregate(data$Precip, by=list(data$season,data$Gradient), sum)
colnames(precip) <- c("season","Gradient","Precip")

p <-ggplot(precip, aes(Gradient, Precip, fill=season)) +geom_bar(stat = "identity", aes(fill = season), position = "dodge")+ scale_fill_manual(values = c("Black","Grey50"))+ scale_x_discrete(limits=c("Panoche","Cuyama","Tejon","Barstow","hwy40","Sheephole","Tecopa")) + scale_y_continuous(expand = c(0, 0))+ylab("Precipitation (mm)") + theme_Publication()+ guides(fill = "none") 
p

### Calculate seasonal gams
site.gps <- read.csv("Data/ERGsites.csv")
names(site.gps)[1] <- "Site"

## seasonal precipitation
season.precip <- data %>% filter(month %in% c(12,1,2)) %>% group_by(Site,season) %>%  summarize(precip=sum(Precip))

season.precip <- merge(site.gps, season.precip, by=c("Site"))
season.precip$gams <- (season.precip$precip*4 - (900-season.precip$elevation)/100*(season.precip$precip*0.4))/season.precip$elevation
season.precip$gams <- atan(season.precip$gams)

```

### Climate patterns within study
```{r fid.height=20, fid.width=28, }
season1.sjd <- season1 %>% filter(Gradient<4) %>% group_by(year, month,days) %>% summarise_if(is.numeric, funs(mean(., na.rm=T)))
season1.mnp <- season1 %>% filter(Gradient>3)%>% group_by(year, month,days) %>% summarise_if(is.numeric, funs(mean(., na.rm=T)))
season2.sjd <- season2 %>% filter(Gradient<4) %>% group_by(year, month,days) %>% summarise_if(is.numeric, funs(mean(., na.rm=T)))
season2.mnp <- season2 %>% filter(Gradient>3)%>% group_by(year, month,days) %>% summarise_if(is.numeric, funs(mean(., na.rm=T)))

## Rain vs Temperature in 2016
par(mfrow=c(2,1))
par(mar=c(3.5,4.5,1,4.5))
plot1 <- barplot(height=season1.sjd$Precip, ylim=c(0,14), ylab="Average precipitation San Joaquin (cm)")
points(plot1[,1], season1.sjd$min.temp, type="l", col="#FF000050", lwd=2)
axis(4, at=seq(0,14,2), lab=seq(0,14,2), ylab="")
mtext("Average temperature at all sites (°C)", 4, line=3)
par(mar=c(4.5,4.5,0,4.5))
plot1 <- barplot(height=season1.mnp$Precip, ylim=c(0,14), ylab="Average precipitation Mojave (cm)")
axis(1, plot1[c(1,30,60,90,120,150,180)], c("Nov","Dec","Jan","Feb","Mar","Apr","May"))
points(plot1[,1], season1.mnp$min.temp, type="l", col="#FF000050", lwd=2)
axis(4, at=seq(0,14,2), lab=seq(0,14,2), ylab="")
mtext("Average temperature at all sites (°C)", 4, line=3)


## Rain vs Temperature in 2017
par(mfrow=c(2,1))
par(mar=c(3.5,4.5,1,4.5))
plot2 <- barplot(height=season2.sjd$Precip, ylim=c(0,14), ylab="Average precipitation San Joaquin (cm)")
points(plot2[,1], season2.sjd$min.temp, type="l", col="#FF000050", lwd=2)
axis(4, at=seq(0,14,2), lab=seq(0,14,2), ylab="")
mtext("Average temperature San Joaquin (°C)", 4, line=3)
par(mar=c(4.5,4.5,0,4.5))
plot2 <- barplot(height=season2.mnp$Precip, ylim=c(0,14), ylab="Average precipitation Mojave (cm)")
points(plot2[,1], season2.mnp$min.temp, type="l", col="#FF000050", lwd=2)
axis(1, plot1[c(1,30,60,90,120,150,180)], c("Nov","Dec","Jan","Feb","Mar","Apr","May"))
axis(4, at=seq(0,14,2), lab=seq(0,14,2), ylab="")
mtext("Average temperature Mojave (°C)", 4, line=3)

### 2016 The rain was inconsistent and mostly absent in the Mojave. This resulted in low germination and producitivty at the southern sites
### 2017 The rain was more plentiful, but in the northern sites, there appears to be a frost period after the majority of the rainfall. Need to check number of frost days

season1.frost <- season1 %>% group_by(Site) %>% summarize(frost.days=sum(min.temp<0, na.rm=T)/length(min.temp)*100)
data.frame(season1.frost)
season2.frost <- season2 %>% group_by(Site) %>% summarize(frost.days=sum(min.temp<0, na.rm=T)/length(min.temp)*100)
data.frame(season2.frost)
## Both years had comparable number of frost days

## Compare number of consecutive frost days (i.e. frost periods)
season1[,"frost"] <- ifelse(season1$min.temp<0, -99,season1$min.temp) ## identified days below freezing
season2[,"frost"] <- ifelse(season2$min.temp<0, -99,season2$min.temp) ## identified days below freezing
count.consec <- function(x) {max(rle(as.character(x))$lengths)}

season1.frost <- season1 %>% group_by(Site)  %>% summarize(count.consec(frost))
data.frame(season1.frost)
season2.frost <- season2 %>% group_by(Site) %>% summarize(count.consec(frost))
data.frame(season2.frost)

## compare only after plants have germinated
season1.frost <- season1 %>% group_by(Site) %>% filter(year>2015) %>% summarize(frost.days=sum(min.temp<0, na.rm=T)/length(min.temp)*100, avg.min.temp=mean(min.temp, na.rm=T))
data.frame(season1.frost)
season2.frost <- season2 %>% group_by(Site) %>%  filter(year>2016) %>%  summarize(frost.days=sum(min.temp<0, na.rm=T)/length(min.temp)*100,avg.min.temp=mean(min.temp, na.rm=T))
data.frame(season2.frost)

season1.frost <- season1 %>% group_by(Site)  %>% filter(year>2015) %>% summarize(count.consec(frost))
data.frame(season1.frost)
season2.frost <- season2 %>% group_by(Site)  %>%  filter(year>2016)%>% summarize(count.consec(frost))
data.frame(season2.frost)

```


### Differences from Nutrient content
```{r}
# nutrient data for each site
nutrients <- read.csv("Data/ERG.soilnutrients.csv")


## join aridity with nutrients
nutrients.climate <- merge(nutrients,subset(gams.data, Year==2016), by=c("Site"))


## Nitrogen difference between shrub and sites
m.nit <- aov(log(N) ~ Site * microsite, data=nutrients)
summary(m.nit)
TukeyHSD(m.nit, "microsite")

## Potassium difference between shrub and sites
m.pot <- aov(log(K) ~ Site * microsite, data=nutrients)
summary(m.pot)
TukeyHSD(m.pot, "microsite")

## Phosphorus difference between shrub and sites
m.pho <- aov(log(P) ~ Site * microsite, data=nutrients)
summary(m.pho)
TukeyHSD(m.pho, "microsite")

nutrient.mean <- nutrients.climate %>% group_by(Site, gams) %>% summarize(nitrogen=mean(N), phosphorus=mean(P), potassium=mean(K))
nutrient.mean <- data.frame(nutrient.mean)
 

ggplot(nutrient.mean) + geom_jitter(aes(x=gams, y=nitrogen), color="#E69F00", size=3) +  stat_smooth(method="lm", formula= y~poly(x,2),aes(x=gams, y=nitrogen), color="#E69F00") + geom_jitter(aes(x=gams, y=potassium/20), color="#56B4E9", size=3) +  stat_smooth(method="lm", formula= y~poly(x,2),aes(x=gams, y=potassium/20), color="#56B4E9") + geom_jitter(aes(x=gams, y=phosphorus), color="#009E73", size=3) +ylab("soil nutrient content")+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),axis.line = element_line(colour = "black"),panel.background = element_blank(),axis.text=element_text(size=14),axis.title=element_text(size=16)) + xlab("rainfall continentality")+
annotate("segment", x = 72, xend = 74, y = 25, yend = 25,  colour = "#56B4E9", size=2) + ## add custom legend
  annotate("text", x = 65, y = 25,  label = "Nitrogen", size=5, hjust=0)+
annotate("segment", x = 72, xend = 74, y = 23, yend = 23,  colour = "#E69F00", size=2) + ## add custom legend
  annotate("text", x = 65, y = 23,  label = "Potassium", size=5, hjust=0)+
annotate("segment", x = 72, xend = 74, y = 21, yend = 21,  colour = "#009E73", size=2) + ## add custom legend
  annotate("text", x = 65, y = 21,  label = "Phosphorus", size=5, hjust=0)


m1 <- lm(nitrogen~poly(gams,2), data=nutrient.mean)
summary(m1)

m2 <- lm(phosphorus~gams, data=nutrient.mean)
summary(m2)

m3 <- lm(potassium~poly(gams,2), data=nutrient.mean)
summary(m3)

```


### Native non-native comparisons
```{r}

### annual plant community repsonse
spp.data  <- read.csv("Data/ERG.communitydata.csv")
spp.data[is.na(spp.data)] <- 0

## load community data
community <- read.csv("Data/ERG.communitydata.csv")
community[is.na(community)] <- 0


## load species list
spp.list <- read.csv("Data/ERG.specieslist.csv")

## convert data to long format
status <- gather(community, species, abundance, 13:53)
names(spp.list)[1] <- "species" ## rename species column for merge

## combine native-non-native status with data set
status <- merge(status, spp.list, by="species")

## summarize per plot native and non-natives, convert back to wide format
mean.status <- status %>% group_by(Year, Site, Microsite, Rep, status) %>% summarize(abundance=sum(abundance))
mean.status <- spread(mean.status, status, abundance)
status.data <- mean.status

## calculate site means for native and non-native
mean.status <- mean.status %>% group_by(Year, Site, Microsite) %>% summarize(native=mean(native), non.native=mean(non.native))


```

### Phylogenetics
```{r warning=FALSE, message=FALSE}

library(picante)
library(ape)
library(brranching)
library(taxize)

## load species list to create tree
spp.list <- read.csv("Data/ERG.specieslist.csv")

## create a combined species name column and drop erinoginum because not to species level
taxa <- paste(spp.list$Genus, spp.list$Species.name)
taxa <- taxa[taxa!="Erinoginum spp"]

## create tree of phylogeny
tree <- phylomatic(taxa=taxa, get = 'POST')

## calculate branch lengths using  Grafen's method
## Grafen, A. (1989) The phylogenetic regression. Philosophical Transactions of the Royal society of London. Series B. Biological Sciences, 326, 119–157.
tree2 <- compute.brlen(tree, method="Grafen")

## view tree and outputs to verify branches
plot(tree2)
tree2

## format community to only have site and microsite
comm <- community %>% group_by(Year, Site, Microsite) %>% summarise_if(is.numeric, funs(sum(., na.rm=T)))
comm <- comm[,c(1:3,13:53)] ## extract species abundances only
comm <- data.frame(comm) ## convert to dataframe
comm[,"site.micro"] <- paste(comm$Site,comm$Microsite,as.character(comm$Year)) ## create site by microsite column
rownames(comm) <- comm[,length(comm)] ## replace row names with site by microsite
comm[,c("Year","Site","Microsite","Erinoginum.spp","Boraginaceae.sp.","site.micro")] <- NULL ## drop all columns but ones for analysis

## match species name format
spp.list[,"spp.name"] <- paste(spp.list$Genus, spp.list$Species.name)
colnames(comm) <- spp.list$spp.name[match(colnames(comm), spp.list$Species.shorthand)]

## match species format
names(comm) <- gsub(" ", "_", names(comm), fixed=T) ## underscores instead of spaces
names(comm) <- gsub("__", "_", names(comm), fixed=T) ## replace double underscores with one
names(comm) <- tolower(names(comm)) ## lower case names


## mean phylogenetic distance
mpd.data <- mpd(comm, cophenetic(tree2), abundance.weighted=T)

## format dataframe
mpd.data <- data.frame(Year=c(rep(2016,14),rep(2017,14)),Microsite=c("open","shrub"),site=rownames(comm), mpd=mpd.data)
mpd.data[,"Site"] <- gsub(" open", "", mpd.data[,"site"]) 
mpd.data[,"Site"] <- gsub(" shrub", "", mpd.data[,"Site"]) 
mpd.data[,"Site"] <- gsub(" 2016", "", mpd.data[,"Site"]) 
mpd.data[,"Site"] <- gsub(" 2017", "", mpd.data[,"Site"]) 
mpd.data[,"site"] <- NULL
mpd.data[is.na(mpd.data)] <- 0 ## barstow no plants
 

## getspecies richness for sites
spp.rich <- community %>% group_by(Year, Site, Microsite) %>% summarize(richness=mean(Richness))
spp.rich <- data.frame(spp.rich)

## join data
mpd.rich <- merge(mpd.data, spp.rich, by=c("Site","Microsite","Year"))

```


### Community analysis
```{r warning=FALSE, message=FALSE, eval=FALSE}

### indicator species analysis
```{r warning=FALSE, message=FALSE}
library(indicspecies)

## indicator species analysis
indval <- multipatt(community[,13:53], community$Microsite, control=how(nperm=999))
summary(indval)


site.names <- as.character(unique(community$Site))
community.site <- subset(community, Site==site.names[7])



## species accumilation curves
accum1 <- specaccum(subset(community.site, Microsite=="shrub", select=13:53), method="random",  permutations=1000)
accum2 <- specaccum(subset(community.site, Microsite=="open", select=13:53), method="random",  permutations=1000)


par(mar=c(4.5,4.5,0.5,0.5))
plot(accum2,  col="#E69F00",ci.col="#E69F0090", xlab="Sampling effort", cex.axis=1.5, cex.lab=1.8, ylab="Species richness", lwd=2, ylim=c(0,16))
plot(accum1,add=T , col="#56B4E9",   ci.col="#56B4E990", lwd=2)


micros <- community$Microsite[1:120]

indval <- multipatt(community.site[,13:53], micros, control=how(nperm=999))
summary(indval)

```

### cluster analysis

```{r warning=FALSE, message=FALSE}
library("cluster")
library("factoextra")
library("magrittr")

comm.sum <- community %>%  group_by(Microsite, Site) %>% summarize_if(is.numeric, funs(sum))
comm.sum <- data.frame(comm.sum)
rownames(comm.sum) <- paste(comm.sum$Microsite,comm.sum$Site)

## coreelation matrix

### Distance measures
res.dist <- get_dist(comm.sum[,13:53], stand = TRUE, method = "euclidean")
fviz_dist(res.dist,    gradient = list(low = "#00AFBB", mid = "white", high = "#FC4E07"))

## dendrogram

## transform data
comm.trans <- decostand(comm.sum[,13:53], "hell")

## clean data for ordination
## see distribution of spp
boxplot(comm.trans, xaxt="n")
labs <- colnames(comm.trans)
text(cex=0.8, x=1:41-1, y=-0.12, labs, xpd=TRUE, srt=45)

## remove spp with only one instancve
comm.trans <- comm.trans[,!colSums(comm.trans)==apply(comm.trans, 2, max)]


## replace outliers with mean
avg.max <- function(x) {
  y =  max(x)
  avg = mean(x)
  x[x==y] <- avg
  return(x)
}
#   
# ## dot chart to find outliers (remove or Avg)
# #dotchart(comm.trans$E.cicutarium) ## Erodium
# comm.trans[,"E.cicutarium"] <- avg.max(comm.trans$E.cicutarium) ## removed outlier
# #dotchart(comm.trans$A.wrangelianus) ## Chilean trefoil
# comm.trans[,"A.wrangelianus"] <- NULL ## removed entire species
# #dotchart(comm.trans$A.lentiginosus) ##
# comm.trans[,"A.lentiginosus"] <- avg.max(comm.trans$A.lentiginosus) ## removed outlier
# #dotchart(comm.trans$H.vulgare) ## Hordeum
# comm.trans[,"H.vulgare"] <- NULL ## removed entire species
# #dotchart(comm.trans$Pectocarya.spp) ## 
# comm.trans[,"Pectocarya.spp"] <- avg.max(comm.trans$Pectocarya.spp) ## removed outlier
# #dotchart(comm.trans$L.arizonicus) ## Lupin 
# comm.trans[,"L.arizonicus"] <- NULL ## removed entire species
# #dotchart(comm.trans$M.bellioides) ##
# comm.trans[,"M.bellioides"] <- NULL ## removed entire species
# #dotchart(comm.trans$B.nigra) ## Mustard
# comm.trans[,"B.nigra"] <- NULL ## removed entire species
# #dotchart(comm.trans$N.demissum) ## Sand Matt
# comm.trans[,"N.demissum"] <- avg.max(comm.trans$N.demissum) ## removed outlier
# #dotchart(comm.trans$L.gracilis) ## 
# comm.trans[,"L.gracilis"] <- avg.max(comm.trans$L.gracilis) ## removed outlier
# #dotchart(comm.trans$A.grandiflora) ##  Amsinckia
# comm.trans[,"A.grandiflora"] <- NULL ## removed entire species
# #dotchart(comm.trans$B.diandrus) ##  Bromus diandrus
# comm.trans[,"B.diandrus"] <- NULL ## removed entire species
# #dotchart(comm.trans$M.affinis) ##  
# comm.trans[,"M.affinis"] <- NULL ## removed entire species
# #dotchart(comm.trans$P.crenulata) ##  
# comm.trans[,"P.crenulata"] <- NULL ## removed entire species
# #dotchart(comm.trans$Erinoginum.spp) # buckwheat
# comm.trans[,"Erinoginum.spp"] <- avg.max(comm.trans$Erinoginum.spp) ## removed outlier
# #dotchart(comm.trans$C.lasiophyllus) # 
# comm.trans[,"C.lasiophyllus"] <- NULL ## removed entire species

# 
# 
# library(usdm)
library(corrplot)
# 
# ## Check for collinearity
# vifcor(comm.trans)
# 
# ## drop Claviformis because of collinear problems in P.insularis
# comm.trans[,"C.claviformis"] <- NULL ## removed entire species
# comm.trans[,"L.decorus"] <- NULL ## removed entire species
# comm.trans[,"E.glyptosperma"] <- NULL ## removed entire species
# comm.trans[,"E.wallacei"] <- NULL ## removed entire species

# ## outliers removed
# cor.dat <- cor(comm.trans[,1:20])
# corrplot(cor.dat, method="number")


## outliers left
cor.dat <- cor(comm.trans[,1:35])
corrplot(cor.dat, method="number")

## calculate distances
dis <- vegdist(comm.trans, method="bray")


## cluster analysis
clus <- hclust(dis, "ward.D2")

## cluster colours
colz <- c("#3e4444", "#86af49", "#405d27","#c1946a")

fviz_dend(clus, k = 4, # Cut in four groups
          cex = 0.7, cex.axis=2, # label size
          k_colors = colz,
          color_labels_by_k = TRUE, # color labels by groups
          rect = TRUE # Add rectangle around groups
          ) 

grp <- cutree(clus, 4)

## Interpretation of classes

## get soil moisture from site/microsite

## Soil moisture
smc <- read.csv("Data/ERG.phytometer.census.csv")
smc.end <- subset(smc, Census=="end")
smc.avg <- smc.end %>% group_by(Site, Microsite) %>% summarize(mean.smc=mean(swc, na.rm=T))
smc.avg <- data.frame(smc.avg)
smc.avg[,"grp"] <- as.factor(c(3,3,2,1,4,4,1,1,4,4,3,3,2,2))

boxplot(mean.smc ~ grp, data=smc.avg)

## CA or PCA
dca1 <- decorana(comm.trans) ## length of gradient >2 & determine relative differences in community composition 


## conduct ordination
ord <- cca(comm.trans)
summary(ord)


## calculate priority
spp.priority <- colSums(comm.trans)

## plot ordination
par(mar=c(4.5,4.5,0.5,0.5))
plot(ord, type="n")
ordiellipse(ord, grp, lty = 2, col = "grey80", draw="polygon", alpha=150)
orditorp(ord, display = "species", cex = 0.7, col = "darkorange3", priority=spp.priority, air=0.8)
orditorp(ord, display = "sites", cex = 0.7, col = "darkslateblue", air=0.1)


##collect environmental variables for site
nutrients <- read.csv("Data/ERG.soilnutrients.csv")
nutrients.mean <- nutrients %>% group_by(microsite, Site) %>% summarise_all(funs(mean))
nutrients.vars <- data.frame(nutrients.mean)


## summarize daily means across sites
HOBO <- read.csv("Data/ERG.logger.data.csv")
HOBO.data <- HOBO %>%  group_by(Site, Microsite, Year, Month, Day) %>% summarize(Temp=mean(Temp),RH=mean(RH))

means <- HOBO.data %>% group_by(Microsite, Site) %>% summarize(Temp.=mean(Temp, na.rm=T),rh=mean(RH, na.rm=T),temp.se=se(Temp),rh.se=se(RH))
means <- data.frame(means)

## soil moisture
smc.early <- subset(smc, Census=="emergence")
smc.avg <- smc.early %>% group_by(Microsite, Site) %>% summarize(SMC=mean(swc, na.rm=T))

envs <- data.frame(swc=smc.avg[,"SMC"],nutrients.vars[,c("N","P","K")], means[,c("Temp.","rh")])

## Check for collinearity
cor(envs)
envs[,"K"] <- NULL ## drop potassium for being correlated
envs[,"rh"] <- NULL ## drop humidity for being correlated

ord.env <- envfit(ord, envs)
plot(ord.env)

```

### Short-term vs long-term effects
[Repeated of analyses separating long- and short- term effects](longshort.effects.html)



### Ordination including aridity and microsite (pCCA)

[Partial Constrained Correspondence Analysis for community data](cca.analysis.html)

### Compare Ambient Community - mixed model results
```{r warning=FALSE, message=FALSE}

community.arid <- merge(community, gams.data, by=c("Year","Site"))

mean.spp <- community.arid %>% group_by(Microsite, Site, gams, Year) %>%  summarize(abd=mean(Abundance),rich=mean(Richness), bio=mean(Biomass))

mean.status2 <- merge(mean.status,gams.data, by=c("Year","Site"))

m1 <- lmer(ihs(bio)~Microsite * gams + (1|Year), data=mean.spp)
shapiro.test(resid(m1))
anova(m1)
r.squaredGLMM(m1) ## R squared values 

m2 <- lmer(ihs(abd)~Microsite * gams + (1|Year), data=mean.spp)
shapiro.test(resid(m2))
car::Anova(m2, type=2)
r.squaredGLMM(m2) ## R squared values 


m2.nat <- lmer(ihs(native)~Microsite * poly(gams,2) + (1|Year), data=mean.status2)
shapiro.test(resid(m2.nat))
anova(m2.nat)
r.squaredGLMM(m2) ## R squared values 

m2.exo <- lmer(ihs(non.native)~Microsite * gams+ (1|Year), data=mean.status2)
shapiro.test(resid(m2.exo))
anova(m2.exo)
r.squaredGLMM(m2) ## R squared values 


m3 <- lmer(rich~Microsite * poly(gams,2) + (1|Year), data=mean.spp)
shapiro.test(resid(m3))
car::Anova(m3, type=2)
r.squaredGLMM(m3) ## R squared values 

## Merge MPD with gams
mpd.gams <- merge(mpd.rich, gams.data, by=c("Site","Year"))

m4 <- lmer(mpd~Microsite * gams + (1|Year), data=mpd.gams)
shapiro.test(resid(m4))
anova(m4)
r.squaredGLMM(m4) ## R squared values 

### Biomass
p1 <- ggplot(mean.spp) + geom_jitter(aes(x=gams, y=ihs(bio)), color="#56B4E9", size=3, data=subset(mean.spp, Microsite=="shrub")) +geom_jitter(aes(x=gams, y=ihs(bio)), color="#E69F00", size=3, data=subset(mean.spp, Microsite=="open"))  + theme_Publication()+ stat_smooth(method="lm", formula= y~poly(x,3),aes(x=gams, y=ihs(bio)), color="#E69F00", fill="#E69F0080", data=subset(mean.spp, Microsite=="open"), lwd=1.4) +  stat_smooth(method="lm", formula= y~poly(x,3),aes(x=gams, y=ihs(bio)), color="#56B4E9", fill="#56B4E970", data=subset(mean.spp, Microsite=="shrub"), lwd=1.4)  + ylab("Annnual plant biomass")+ xlab("")  #annotate("text", x=-4.5,y=4, label="a", size=8)+coord_cartesian(ylim=c(0, 4))

### abundance
p2 <- ggplot(mean.spp) + geom_jitter(aes(x=gams, y=ihs(abd)), color="#56B4E9", size=3, data=subset(mean.spp, Microsite=="shrub")) +geom_jitter(aes(x=gams, y=ihs(abd)), color="#E69F00", size=3, data=subset(mean.spp, Microsite=="open"))  + theme_Publication()+  stat_smooth(method="lm", formula= ihs(y)~x,aes(x=gams, y=abd), color="black", fill="Grey50", data=mean.spp, lwd=1.4)+ ylab("Annual plant abundance")+ xlab("")+ annotate("text", x=-4.5,y=6, label="b", size=8)

### richness
p3 <- ggplot(mean.spp) + geom_jitter(aes(x=gams, y=rich), color="#56B4E9", size=3, data=subset(mean.spp, Microsite=="shrub")) +geom_jitter(aes(x=gams, y=rich), color="#E69F00", size=3, data=subset(mean.spp, Microsite=="open"))  + theme_Publication()+ stat_smooth(method="lm", formula= y~poly(x,2),aes(x=gams, y=rich), color="#E69F00", fill="#E69F0080", data=subset(mean.spp, Microsite=="open"), lwd=1.4) +  stat_smooth(method="lm", formula= y~poly(x,2),aes(x=gams, y=rich), color="#56B4E9", fill="#56B4E970", data=subset(mean.spp, Microsite=="shrub"), lwd=1.4)  + ylab("Species richness") + xlab("Aridity Gradient")+ annotate("text", x=-4.5,y=4, label="c", size=8)

### phylogenetic diveristy
p4 <- ggplot(mpd.gams)+ geom_jitter(aes(x=gams, y=mpd), color="#56B4E9", size=3, data=subset(mpd.gams, Microsite=="shrub")) +geom_jitter(aes(x=gams, y=mpd), color="#E69F00", size=3, data=subset(mpd.gams, Microsite=="open"))  +  stat_smooth(method="lm", formula= y~x,aes(x=gams, y=mpd), data=subset(mpd.gams, Microsite=="shrub"), color="#56B4E9",fill="#56B4E980", lwd=1.4)+  stat_smooth(method="lm", formula= y~x,aes(x=gams, y=mpd), data=subset(mpd.gams, Microsite=="open"), color="#E69F00",fill="#E69F0080", lwd=1.4)+ ylab("Phylogenetic Community Dissimilarity") + xlab("Aridity Gradient")+ theme_Publication()+ annotate("text", x=-4.5,y=1.8, label="d", size=8)

grid.arrange(p1,p2,p3,p4)

```

### Compare environmental differences - mixed model results
```{r warning= FALSE, message=FALSE}

### Nutrients 
nutrient.mean <- nutrients.climate %>% group_by(Site, microsite) %>% summarize(nitrogen=mean(N), phosphorus=mean(P), potassium=mean(K))
nutrient.mean <- data.frame(nutrient.mean,gams=rep(gams.data[gams.data$Year==2016,"gams"],each=2))

## potassium
m5 <- lm(potassium ~ poly(gams,2)* microsite, data=nutrient.mean)
summary(m5)
anova(m5)
r.squaredGLMM(m5) ## R squared values 

p5 <- ggplot(nutrient.mean) + geom_jitter(aes(x=gams, y=potassium), color="#56B4E9", size=3, data=subset(nutrient.mean, microsite=="shrub"))+ geom_jitter(aes(x=gams, y=potassium), color="#E69F00", size=3, data=subset(nutrient.mean, microsite=="open"))+  stat_smooth(method="lm", formula= y~x,aes(x=gams, y=potassium), color="#56B4E9", fill="#56B4E980", data=subset(nutrient.mean, microsite=="shrub"), lwd=1.4) +  
  stat_smooth(method="lm", formula= y~x,aes(x=gams, y=potassium), color="#E69F00", fill="#E69F0080",data=subset(nutrient.mean, microsite=="open"), lwd=1.4)+ ylab("Nitrogen (ppm)") + xlab("")+ theme_Publication()+ annotate("text", x=-4.5,y=32, label="a", size=8)+coord_cartesian(ylim=c(0, 32))



se <- function(x) sd(na.omit(x))/sqrt(length(na.omit(x)))

swc <- smc %>% group_by(Year, Site, Microsite, Census) %>% summarize(swc.avg=mean(swc), swc.se=se(swc))
smc.gams <- merge(swc, gams.data, by=c("Site","Year"))


## early swc
smc.early <- subset(smc.gams, Census=="emergence")


m6 <- lmer(swc.avg~Microsite * poly(gams,2) + (1|Year), data=smc.early)
shapiro.test(resid(m6))
anova(m6)
r.squaredGLMM(m6) ## R squared values 


### soil moisture at emergence
p6 <- ggplot(smc.early) + geom_jitter(aes(x=gams, y=swc.avg), color="#56B4E9", size=3, data=subset(smc.early, Microsite=="shrub")) +geom_jitter(aes(x=gams, y=swc.avg), color="#E69F00", size=3, data=subset(smc.early, Microsite=="open"))  + theme_Publication()+ stat_smooth(method="lm", formula= y~poly(x,2),aes(x=gams, y=swc.avg), data=smc.early, lwd=1.4, color="black") + ylab("Soil moisture at emergence (%)") + xlab("Aridity Gradient")+ annotate("text", x=-4.5,y=30, label="c", size=8)


## Create seasons for hobo
season1 <- subset(HOBO.data, Year==2015 & Month > 10 | Year==2016 & Month < 5)
season2 <- subset(HOBO.data, Year==2016 & Month > 10 | Year==2017 & Month < 5)
HOBO.season <- rbind(season1,season2)
HOBO.season[,"season"] <- c(rep("season.1",nrow(season1)),rep("season.2",nrow(season2)))
HOBO.season <- na.omit(HOBO.season)

hobo.means <- HOBO.season %>% group_by(season, Microsite, Site) %>% summarize(temp.avg=mean(Temp),temp.var=var(Temp),temp.sd=sd(Temp),temp.se=se(Temp),rh.avg=mean(RH, na.rm=T),rh.var=var(RH, na.rm=T),rh.se=se(RH),frost=(sum(na.omit(Temp)<0)/length(na.omit(Temp))*100),heat=(sum(na.omit(Temp)>30)/length(na.omit(Temp))*100))
hobo.means[,"Year"] <- c(rep(2016,14),rep(2017,14))

hobo.arid <- merge(hobo.means, gams.data, by=c("Site","Year"))
# hobo.arid[,"CV"] <-hobo.arid[,"temp.sd"] /hobo.arid[,"CV"] 

## temperature variability
m7 <- lmer(temp.var~Microsite * poly(gams,2) + (1|Year), data=hobo.arid)
shapiro.test(resid(m7))
anova(m7)
r.squaredGLMM(m7) ## R squared values 


p7 <- ggplot(hobo.arid) + geom_jitter(aes(x=gams, y=temp.var), color="#56B4E9", size=3, data=subset(hobo.arid, Microsite=="shrub")) +geom_jitter(aes(x=gams, y=temp.var), color="#E69F00", size=3, data=subset(hobo.arid, Microsite=="open"))  + theme_Publication()+ stat_smooth(method="lm", formula= y~poly(x,2),aes(x=gams, y=temp.var), color="#E69F00", fill="#E69F0080", data=subset(hobo.arid, Microsite=="open"), lwd=1.4) +  stat_smooth(method="lm", formula= y~poly(x,2),aes(x=gams, y=temp.var), color="#56B4E9", fill="#56B4E970", data=subset(hobo.arid, Microsite=="shrub"), lwd=1.4)  + ylab("Temperature variation") + xlab("Aridity Gradient")+ annotate("text", x=-4.5,y=125, label="d", size=8) 

shrubz <- read.csv("Data/ERG.shrub.csv")
shrub.mean <- shrubz %>% group_by(Site, Microsite) %>% summarize(compact=mean(Compaction))

shrub.clim <- data.frame(shrub.mean, gams=rep(gams.data[gams.data$Year==2016,"gams"],each=2))
#shrub.clim <- subset(shrub.clim, Year==2016)

m8 <- lm(log(compact)  ~  Microsite * gams, data=shrub.clim)
summary(m8)
anova(m8)
r.squaredGLMM(m8) ## R squared values 



p8 <- ggplot(shrub.clim) + geom_jitter(aes(x=gams, y=compact), color="#56B4E9", size=3, data=subset(shrub.clim, Microsite=="shrub"))+ geom_jitter(aes(x=gams, y=compact), color="#E69F00", size=3, data=subset(shrub.clim, Microsite=="open"))+  stat_smooth(method="lm", formula= y~exp(x),aes(x=gams, y=compact), color="#56B4E9", fill="#56B4E980", data=subset(shrub.clim, Microsite=="shrub"), lwd=1.4) +  
  stat_smooth(method="lm", formula= y~exp(x),aes(x=gams, y=compact), color="#E69F00", fill="#E69F0080",data=subset(shrub.clim, Microsite=="open"), lwd=1.4)+ ylab("Soil compaction") + xlab("")+ theme_Publication() + annotate("text", x=-4.4,y=2.5, label="b", size=8) +coord_cartesian(ylim=c(0.5, 2.5))

grid.arrange(p5,p8,p6,p7)


```



```{r warning=FALSE, message=FALSE}
### Microsite comparisons



# nut <- read.csv("Data//ERG.soilnutrients.csv")
# 
# fit1 <- aovp(N ~ microsite, data=nut)
# summary(fit1)
# t.test(N ~ microsite, data=nut)
# fit2 <- aovp(P ~ microsite, data=nut)
# t.test(P ~ microsite, data=nut)
# summary(fit2)
# fit3 <- aovp(K ~ microsite, data=nut)
# t.test(K ~ microsite, data=nut)
# summary(fit3)
# 
# compact <- read.csv("Data//ERG.shrub.csv")
# 
# fit4 <- aovp(Compaction ~ Microsite, data=compact)
# t.test(Compaction ~ Microsite, data=compact)
# summary(fit4)
# 
# soilmoist <- read.csv("Data//ERG.phytometer.census.csv")
# 
# fit5 <- aovp(swc ~ Microsite, data=subset(soilmoist, Census=="emergence"))
# summary(fit5)
# t.test(swc ~ Microsite, data=subset(soilmoist, Census=="emergence"))
# 
# micro <- read.csv("Data//ERG.logger.data.csv")
# 
# micro.avg <- micro %>% group_by(Year, Site, Microsite, Rep) %>% summarize(temp=mean(Temp), rh=mean(RH))
# 
# fit6 <- aovp(temp ~ Microsite, data=micro.avg)
# summary(fit6)
# t.test(temp ~ Microsite, data=micro.avg)
# 
# fit7 <- aovp(rh ~ Microsite, data=micro.avg)
# summary(fit7)
# t.test(rh ~ Microsite, data=micro.avg)
```

### Plot level GLMM
```{r warning=FALSE, message=FALSE}

m1 <- glmer.nb(Abundance ~ Microsite * gams + (1|Year), data=community.arid)
car::Anova(m1, type=2)
coef(m1)

source("rsquared.r")

m2 <- glmer.nb(Richness ~ Microsite * poly(gams,2) + (1|Year), data=community.arid)
car::Anova(m2, type=2)
# rsquared.glmm(m2)

# m2.gam <- gam(Richness~ Microsite +s(gams, k=3) + s(gams, by=Microsite, k=3) + s(Year, bs="re"), family=poisson, data=community.arid)


p1 <- ggplot(community.arid, aes(x=gams, y=Richness)) + geom_jitter(aes(x=gams, y=Richness), color="#181818", size=3, alpha=0.4, width = 0.75,shape = 1, data=subset(community.arid, Microsite=="shrub")) +geom_jitter(aes(x=gams, y=Richness), color="#181818", size=2,alpha=0.4, data=subset(community.arid, Microsite=="open"),shape = 2, width = 0.75)  + theme_Publication() +
  stat_smooth(method="gam", method.args=list(family="poisson"), formula= y~s,aes(x=gams, y=Richness), color="#181818", fill="#80808080", data=subset(community.arid, Microsite=="open"), lwd=2, lty=2)


## richness
p1 <- ggplot(community.arid) + geom_jitter(aes(x=gams, y=Richness), color="#181818", size=3, alpha=0.4, width = 0.75,shape = 1, data=subset(community.arid, Microsite=="shrub")) +geom_jitter(aes(x=gams, y=Richness), color="#181818", size=2,alpha=0.4, data=subset(community.arid, Microsite=="open"),shape = 2, width = 0.75)  + theme_Publication() +  ylab("species richness") + xlab("Gams index of continentality")+ 
  geom_smooth(method="glm", method.args=list(family="poisson"), formula= y~poly(x,2),aes(x=gams, y=Richness), color="#181818", fill="#80808080" , data=subset(community.arid, Microsite=="shrub"), lwd=2) + 
  geom_smooth(method="glm", method.args=list(family="poisson"), formula= y~poly(x,2),aes(x=gams, y=Richness), color="#181818", fill="#80808080", data=subset(community.arid, Microsite=="open"), lwd=2, lty=2)+  ylab("Species richness") + xlab("") + annotate("text", x=50,y=6, label="a", size=8) 
  

m3<- lmer(ihs(Biomass) ~ Microsite * poly(gams,2) + (1|Year), data=community.arid)
anova(m3)
r.squaredGLMM(m3) ## R squared values

# m3.gam <- gam(ihs(Biomass)~  s(gams, by=Microsite, k=3) + s(Year, bs="re"), family=gaussian, data=community.arid)
# 

## biomass
p2 <- ggplot(community.arid) + geom_jitter(aes(x=gams, y=ihs(Biomass)), color="#181818", size=3, width = 0.75,shape = 1, alpha=0.5, data=subset(community.arid, Microsite=="shrub")) +geom_jitter(aes(x=gams, y=ihs(Biomass)), color="#181818", size=2,shape = 2,alpha=0.5, width = 0.75, data=subset(community.arid, Microsite=="open"))  + theme_Publication() + 
  geom_smooth(method="lm", formula= y~poly(x,2),aes(x=gams, y=ihs(Biomass)), color="#181818", fill="#80808080", data=subset(community.arid, Microsite=="shrub"), lwd=2) + 
  geom_smooth(method="lm", formula= y~poly(x,2),aes(x=gams, y=ihs(Biomass)), color="#181818", fill="#80808080", data=subset(community.arid, Microsite=="open"), lwd=2, lty=2)+  ylab("Annual biomass") + xlab("")+ annotate("text", x=50,y=5, label="b", size=8) 
  

m4<- lmer(mpd~ Microsite * gams + (1|Year), data=mpd.gams)
anova(m4)
r.squaredGLMM(m4) ## R squared values

## phylogenetic diversity
p3 <- ggplot(mpd.gams)+ geom_jitter(aes(x=gams, y=mpd), color="#181818", size=3,shape=1, alpha=0.4, data=subset(mpd.gams, Microsite=="shrub")) +geom_jitter(aes(x=gams, y=mpd), color="#181818",alpha=0.4, size=2,shape=2, data=subset(mpd.gams, Microsite=="open"))  +  stat_smooth(method="lm", formula= y~x,aes(x=gams, y=mpd), data=subset(mpd.gams, Microsite=="shrub"), color="#181818",fill="#80808080", lwd=2)+  stat_smooth(method="lm", formula= y~x,aes(x=gams, y=mpd), data=subset(mpd.gams, Microsite=="open"), color="#181818",fill="#80808080", lwd=2, lty=2)+ ylab("Phylogenetic community dissimilarity") + xlab("Gams index of continentality")+ theme_Publication()+ annotate("text", x=50,y=1.4, label="c", size=8) 


## native vs non-native
status.gams <- merge(status.data, gams.data, by=c("Year","Site"))

m5<- glmer.nb(native~ Microsite * scale(gams) + (1|Year), data=status.gams) ## need to scale data
car::Anova(m5, type=3)
# rsquared.glmm(m5)


m6<- glmer.nb(non.native~ Microsite * scale(gams) + (1|Year), data=status.gams)   ## need to scale data
car::Anova(m6, type=3)
# rsquared.glmm(m5)


status.plot <- gather(status.gams, origin, abundance, 5:6)

p4 <- ggplot(subset(status.plot, abundance>0)) + geom_jitter(aes(x=gams, y=abundance), color="#181818", size=3, data=subset(status.plot, Microsite=="shrub"), width = 1, shape=1, alpha=0.3) +geom_jitter(aes(x=gams, y=abundance), width = 1, color="#181818", size=2,alpha=0.3,shape=2, data=subset(status.plot, Microsite=="open"))  + theme_Publication() + 
  geom_smooth(method="glm", method.args=list(family="poisson"), formula= y~x,aes(x=gams, y=abundance), color="#505050", se=F, data=subset(status.plot, Microsite=="open" & origin=="native"), lwd=2, lty=2)+
  geom_smooth(method="glm", method.args=list(family="poisson"), formula= y~x,aes(x=gams, y=abundance),se=F, color="#181818",  data=subset(status.plot, Microsite=="open" & origin=="non.native"), lwd=2, lty=2)+
 geom_smooth(method="glm", method.args=list(family="poisson"), formula= y~x,aes(x=gams, y=abundance),se=F, color="#505050", data=subset(status.plot, Microsite=="shrub" & origin=="native"), lwd=2)+
  geom_smooth(method="glm", method.args=list(family="poisson"), formula= y~x,aes(x=gams, y=abundance),se=F, color="#181818",  data=subset(status.plot, Microsite=="shrub" & origin=="non.native"), lwd=2) +  ylab("Annual plant abundance") + xlab("Gams index of continentality")+ annotate("text", x=50,y=310, label="d", size=8) 


grid.arrange(p1,p2,p3,p4)


### Nutrients 
nutrient.mean <- nutrients.climate %>% group_by(Site, gams, microsite) %>% summarize(nitrogen=mean(N), phosphorus=mean(P), potassium=mean(K))
nutrient.mean <- data.frame(nutrient.mean,gams=rep(gams.data[gams.data$Year==2016,"gams"],each=2))

## nitrogen
m5 <- lm(nitrogen ~ poly(gams,2)* microsite, data=nutrient.mean)
summary(m5)
anova(m5)
r.squaredGLMM(m5) ## R squared values 

p5 <- ggplot(nutrient.mean) + geom_jitter(aes(x=gams, y=nitrogen), color="#181818", size=3, shape=16,alpha=0.5, data=subset(nutrient.mean, microsite=="shrub"))+ geom_jitter(aes(x=gams, y=nitrogen), color="#181818", size=3,shape=17, alpha=0.4, data=subset(nutrient.mean, microsite=="open"))+  stat_smooth(method="lm", formula= y~poly(x,2),aes(x=gams, y=nitrogen), color="#181818", fill="#80808080", data=subset(nutrient.mean, microsite=="shrub"), lwd=2) +  
  stat_smooth(method="lm", formula= y~poly(x,2),aes(x=gams, y=nitrogen), color="#181818", fill="#80808080",data=subset(nutrient.mean, microsite=="open"), lwd=2, lty=2)+ ylab("Nitrogen (ppm)") + xlab("")+ theme_Publication()+ coord_cartesian(ylim=c(-2, 26)) + xlab("")+ annotate("text", x=63,y=25, label="a", size=8) 


smc.early <- subset(smc, Census=="emergence")
smc.early <- merge(smc.early, gams.data, by=c("Year","Site"))
smc.early <- smc.early %>% group_by(Year, Site, gams, Microsite) %>% summarize(swc.avg=mean(swc))

## nitrogen
m6 <- lmer(log(swc.avg) ~ poly(gams,2)* Microsite + (1|Year), data=smc.early)
summary(m6)
anova(m6)
r.squaredGLMM(m6) ## R squared values 


p6 <- ggplot(smc.early) + geom_jitter(aes(x=gams, y=swc.avg), color="#181818", size=3, shape=16,alpha=0.5, data=subset(smc.early, Microsite=="shrub")) +geom_jitter(aes(x=gams, y=swc.avg), color="#181818", size=3,shape=17,alpha=0.5, data=subset(smc.early, Microsite=="open"))  + theme_Publication()+ stat_smooth(method="lm", formula= y~poly(x,2),aes(x=gams, y=swc.avg), data=smc.early, lwd=2, color="black") + ylab("Soil moisture at emergence (%)")  + xlab("")+ annotate("text", x=50,y=35, label="b", size=8) 


## temperature variability
m7 <- lmer(temp.var~Microsite * poly(gams,2) + (1|Year), data=hobo.arid)
shapiro.test(resid(m7))
anova(m7) 
r.squaredGLMM(m7) ## R squared values 


p7 <- ggplot(hobo.arid) + geom_jitter(aes(x=gams, y=temp.var), color="#181818", size=3, shape=16, alpha=0.5, data=subset(hobo.arid, Microsite=="shrub")) +geom_jitter(aes(x=gams, y=temp.var), color="#181818", size=3, shape=17, alpha=0.5, data=subset(hobo.arid, Microsite=="open"))  + theme_Publication()+ stat_smooth(method="lm", formula= y~poly(x,2),aes(x=gams, y=temp.var), color="#181818", fill="#80808080", data=subset(hobo.arid, Microsite=="open"), lwd=2, lty=2) +  stat_smooth(method="lm", formula= y~poly(x,2),aes(x=gams, y=temp.var), color="#181818", fill="#80808080", data=subset(hobo.arid, Microsite=="shrub"), lwd=2)  + ylab("Temperature variation") + xlab("Gams index of continentality")+ annotate("text", x=50,y=125, label="c", size=8) 


## soil compaction
m8 <- lm(log(compact)  ~  Microsite * gams, data=shrub.clim)
summary(m8)
anova(m8)
r.squaredGLMM(m8) ## R squared values 

p8 <- ggplot(shrub.clim) + geom_jitter(aes(x=gams, y=log(compact)), color="#181818", size=3, shape=16, alpha=0.5, data=subset(shrub.clim, Microsite=="shrub")) +geom_jitter(aes(x=gams, y=log(compact)), color="#181818", size=3, shape=17, alpha=0.5, data=subset(shrub.clim, Microsite=="open"))  + theme_Publication()+ stat_smooth(method="lm", formula= y~x, aes(x=gams, y=log(compact)), color="#181818", fill="#80808080", data=subset(shrub.clim, Microsite=="open"), lwd=2, lty=2) +  stat_smooth(method="lm", formula= y~x,aes(x=gams, y=log(compact)), color="#181818", fill="#80808080", data=subset(shrub.clim, Microsite=="shrub"), lwd=2)  + ylab("Soil compaction") + xlab("Gams index of continentality")+ annotate("text", x=63,y=1.1, label="d", size=8) 

grid.arrange(p5,p6,p7,p8)

```

### Phytometer with GAMS
```{r warning=FALSE, message=FALSE}
census <- read.csv("Data/ERG.phytometer.census.csv")
census[is.na(census)] <- 0
census.arid <- merge(census,gams.data, by=c("Year","Site"))

## treatment plots
census.long <- gather(census.arid, species, biomass, 12:14)
census.long[,"species"] <- ifelse(census.long[,"species"] =="Phacelia.biomass", "P. tanacetifolia",
                                  ifelse(census.long[,"species"]=="Plantago.biomass","P. insularis","S. columbariae"))
census.long[,"species"] <- as.factor(census.long$species)

## microsite average
census.micro <- census.long %>% filter(biomass>0) %>%  group_by(Microsite, species) %>%  summarize(Biomass=mean(biomass), error=se(biomass))

p9 <- ggplot(census.micro, aes(x=species, y=Biomass, fill=Microsite)) +   geom_bar(position=position_dodge(), stat="identity", colour="black") + scale_fill_brewer(palette="Greys")+  geom_errorbar(aes(ymin=Biomass-error, ymax=Biomass+error),
                  width=.2,                    # Width of the error bars
                  position=position_dodge(.9))+ theme_Publication() + theme(axis.text.x = element_text(size=16, face="italic"),axis.text.y = element_text(size=16),axis.title = element_text(size=20),legend.text=element_text(size=18))

## nutrient average
census.nut <- census.long %>% filter(biomass>0) %>%  group_by(Nutrient, species) %>%  summarize(Biomass=mean(biomass), error=se(biomass))

p10 <- ggplot(census.nut, aes(x=species, y=Biomass, fill=Nutrient)) +   geom_bar(position=position_dodge(), stat="identity",colour="black") + scale_fill_brewer(palette="Greys")+  geom_errorbar(aes(ymin=Biomass-error, ymax=Biomass+error),
                  width=.2,                    # Width of the error bars
                  position=position_dodge(.9))+ theme_Publication()+ theme(axis.text.x = element_text(size=16, face="italic"),axis.text.y = element_text(size=16),axis.title = element_text(size=20),legend.text=element_text(size=18))



## logistic first
census.long[,"presence"] <- ifelse(census.long$biomass>0,1,0)
## Drop panoche 2017 because of cold
census.npan <- census.long %>% filter(Site!="PanocheHills" | Year!="2017")


m1.l <- glmer(presence~Microsite * gams * Nutrient + (1|Year),data=subset(census.npan, species=="P. tanacetifolia"), family=binomial)
car::Anova(m1.l, type=2)


m1 <- lmer(log(biomass)~Microsite * poly(gams,2) * Nutrient + (1|Year),data=subset(census.long, species=="P. tanacetifolia" & presence==1))
shapiro.test(resid(m1))
anova(m1)
r.squaredGLMM(m1) ## R squared values 



m2.l <- glmer(presence~Microsite * poly(gams,2) * Nutrient + (1|Year),data=subset(census.npan, species=="P. insularis"), family=binomial)
car::Anova(m2.l, type=2)
m2 <- lmer(log(biomass)~Microsite * poly(gams,2) * Nutrient + (1|Year), data=subset(census.long, species=="P. insularis" & presence==1))
shapiro.test(resid(m2))
anova(m2)
r.squaredGLMM(m2) ## R squared values 

m3.l <- glmer(presence~Microsite * poly(gams,2) * Nutrient + (1|Year),data=subset(census.npan, species=="S. columbariae"), family=binomial)
car::Anova(m3.l, type=3)

m3 <- lmer(log(biomass)~Microsite * poly(gams,2) * Nutrient + (1|Year), data=subset(census.long, species=="S. columbariae" & biomass>0))
shapiro.test(resid(m3))
anova(m3)
r.squaredGLMM(m3) ## R squared values 


## summary presence
mean.occ <- census.npan %>% group_by(gams,species, Microsite) %>% summarize(presence=mean(presence))


p11 <- ggplot(census.npan, aes(x=gams, y=presence, fill=species, color=species))  + theme_Publication()+  
  geom_smooth(method="glm", method.args=list(family="binomial"), formula= y~x,aes(x=gams, y=presence),fill="#0daec2", color="#0daec2",  data=subset(census.npan, species=="P. tanacetifolia" & Microsite=="shrub"), lwd=2)+  
  geom_smooth(method="glm", method.args=list(family="binomial"), formula= y~x,aes(x=gams, y=presence),fill="#0daec2", color="#0daec2",  data=subset(census.npan, species=="P. tanacetifolia"& Microsite=="open"), lwd=2, lty=2) +  geom_smooth(method="glm", method.args=list(family="binomial"), formula= y~poly(x,2),aes(x=gams, y=presence), color="#fb6f70", fill="#fb6f7050",  data=subset(census.npan, species=="P. insularis"), lwd=2)+ geom_smooth(method="glm", method.args=list(family="binomial"), formula= y~poly(x,2),aes(x=gams, y=presence),fill="#b7d73850", color="#b7d738",  data=subset(census.npan, species=="S. columbariae"), lwd=2)+ ylab("Probability of occurrence") + xlab("Gams index of continentality")


p12 <- ggplot(census.long, aes(x=gams, y=biomass, fill=species, color=species))  + theme_Publication() +  geom_smooth(method="lm", formula= y~poly(x,2),aes(x=gams, y=log(biomass)), color="#fb6f70", fill="#fb6f7050",  data=subset(census.long, species=="P. insularis" & biomass>0), lwd=2, fullrange=TRUE) + geom_smooth(method="lm", formula= y~poly(x,2),aes(x=gams, y=log(biomass)),fill="#b7d73850", color="#b7d738",  data=subset(census.long, species=="S. columbariae"& biomass>0), lwd=3)+
  geom_smooth(method="lm", formula= y~poly(x,2),aes(x=gams, y=log(biomass)),fill="#0daec2", color="#0daec2",  data=subset(census.long, species=="P. tanacetifolia" & biomass>0 & Microsite=="shrub"), lwd=2, fullrange=TRUE)+geom_smooth(method="lm", formula= y~poly(x,2),aes(x=gams, y=log(biomass)),fill="#0daec2", color="#0daec2",  data=subset(census.long, species=="P. tanacetifolia" & biomass>0 & Microsite=="open"), lwd=2,lty=2, fullrange=TRUE)+ ylab("Phytometer biomass") + xlab("Gams index of continentality") 


grid.arrange(p9,p11,p10, p12)
```

### Appendix A Fig1: Map
```{r message=FALSE, warning=FALSE}
## Load libraries
library(ggmap)

## load site info
site <- c("PanocheHills","Cuyama","Barstow","HeartofMojave","SheepholeValley","Tecopa","TejonRanch")
gradient <- c(1,2,5,4,6,7,3)
lat <- c(36.70000998,34.85521998,35.094051,34.698199,34.205676,35.85151504,34.875994)
lon <- c(-120.801116,-119.48851,-116.8349,-115.684169,-115.719676,-116.186706,-118.60246)
elevation <- c(656.320862,806.83429,496.02,784.73,545.92,699.456665,1118.022)
site.data <- data.frame(site, gradient, lat, lon, elevation)

## identify site map
cali.box <- c(-128, 34, -110, 38)

## get map
cali.map <- get_map(location=cali.box, source="google", maptype="terrain", crop=FALSE, color="bw")

## plot map with locations
ggmap(cali.map) + geom_point(aes(x=lon, y=lat), data=site.data, color="blue", size=4) + xlab("longitude") + ylab("latitude") +
  annotate('text', x=lon[1]+.4, y=lat[1]+0.2, label = "Panoche Hills", colour = "blue") + #PAN
  annotate('text', x=lon[2], y=lat[2]+0.17, label = "Cuyama Valley", colour = "blue") + #CUY
  annotate('text', x=lon[3], y=lat[3]+0.18, label = "Barstow", colour = "blue") + #BAR
  annotate('text', x=lon[4], y=lat[4]+0.18, label = "Heart of the Mojave", colour = "blue") + #MNP
  annotate('text', x=lon[5], y=lat[5]+0.18, label = "Sheephole Valley Wilderness", colour = "blue") + #SVW
  annotate('text', x=lon[6], y=lat[6]+0.18, label = "Tecopa", colour = "blue") + #TEC
  annotate('text', x=lon[7], y=lat[7]+0.24, label = "Tejon Ranch", colour = "blue") #TJR

# ## plot worldclim data
# library(raster)
# library(sp)
# 
# ## get worldclim variables
# cal1 <- getData("worldclim",var="bio", lon=-118, lat=35, res=0.5) ## right side of California 
# cal2 <- getData("worldclim",var="bio", lon=-122, lat=35, res=0.5) ## left side of california
# cal.all <- merge(cal1,cal2)
# cal.all <- cal.all[[c(12)]]
# names(cal.all) <- c("Prec")
# 
# ## convert sites to spatial points 
# coordinates(site.data) <- ~lon+lat
# proj4string(site.data) <- cal.all@crs
# 
# ## plot points and precipitation maps
# par(mar=c(4.5,4.5,0.5,0.5))
# plot(cal.all, xlim=c(-122,-114), ylim=c(34,38), xlab="longitude", ylab="latitude", cex.lab=1.5, cex.axis=1.3)
# plot(site.data,add=T, pch=19, col="blue", cex=2)
# text(lon[1],lat[1]+0.2, "Panoche Hills", col="blue", cex=1)
# text(lon[2],lat[2]+0.17, "Cuyama Valley", col="blue", cex=1)
# text(lon[3],lat[3]+0.2, "Barstow", col="blue", cex=1)
# text(lon[4],lat[4]+0.2, "Heart of the Mojave", col="blue", cex=1)
# text(lon[5],lat[5]+0.2, "Sheephole Valley Wilderness", col="blue", cex=1)
# text(lon[6],lat[6]+0.2, "Tecopa", col="blue", cex=1)
# text(lon[7],lat[7]+0.25, "Tejon Ranch", col="blue", cex=1)

```

