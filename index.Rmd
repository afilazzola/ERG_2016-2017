---
title: 'The effect of a dominant shrub on annuals plants in a desert system changes along a gradient of precipitation.'
author: "Alex Filazzola"
date: "May 2017"
output:
  html_document:
    theme: yeti
    toc: yes
    toc_depth: 3
    toc_float: yes
---
###Ephedra regional gradient (ERG) analyses

![](./ephedra_cover.JPG)

[ecoblender](http://ecoblender.org)

[alex.filazzola](http://www.filazzola.info)

#### Abstract

An under-examined component of the shrub-annual relationship is how regional drivers, such as climate, may alter the sign or magnitude of positive interactions. Interspecific interactions between plants have been shown to be strongly linked to climate, particularly temperature and precipitation. The stress-gradient hypothesis (SGH) predicts that higher abiotic stress (i.e. for deserts, increasing temperature and reduced precipitation) will increase the frequency of positive interactions among shrubs and their annual understory. Regional climate gradients also have indirect effects on plant composition, such as determining consumer abundance and soil nutrient composition. Nutrient availability is particularly affected by precipitation because of altered decomposition rates of organic matter and mineralization. Therefore, the strength of facilitation and operating mechanism of a shrub on the annual plant community may change along a regional gradient. 

#### Hypothesis

We tested the hypothesis that positive interactions among shrubs and annual plants will increase with abiotic stress and reduce nutrient availability along a regional gradient of aridity.

#### Methods

![](./ERGmethods.JPG)

```{r load packages, echo=FALSE, warning=FALSE, message=FALSE}
## load packages for spatial manipulation
library(raster)
library(rgdal)
library(dismo)
#library(rJava)
#library(maptools)
library(dplyr)
library(vegan)
library(MASS)
library(ggplot2)
```


``` {r load functions, echo=FALSE}
error.bar <- function(x, y, upper, lower=upper, length=0,...){
if(length(x) != length(y) | length(y) !=length(lower) | length(lower) != length(upper))
stop("vectors must be same length")
arrows(x,y+upper, x, y-lower, angle=90, code=3, length=length, ...)
}

se <- function(x) sd(x)/sqrt(length(x)) ## standard error

```

### Weather for growing season
```{r echo=FALSE, fid.width=28}

## weather station data

data <- read.table("data.twoseasons/ERG.climatedata.csv", header=T,sep=",")
site.names <- c("Panoche","Cuyama","Tejon","Barstow","hwy40","Sheephole","Tecopa")
season1 <- subset(data, year==2015 & month > 10 | year==2016 & month < 5)
season2 <- subset(data, year==2016 & month > 10 | year==2017 & month < 5)
data <- rbind(season1,season2)
data[,"season"] <- c(rep("season.1",nrow(season1)),rep("season.2",nrow(season2)))
data <- na.omit(data)

means <- aggregate(data$avg.temp, by=list(data$season,data$Gradient), mean)
means.se <- aggregate(data$avg.temp, by=list(data$season,data$Gradient), se)
means[,"se"] <- means.se[,3]
colnames(means) <- c("season","gradient","avg","se")
means[,"upper"] <- means[,"avg"]+means[,"se"]*1.96
means[,"lower"] <- means[,"avg"]-means[,"se"]*1.96

q <- ggplot(means, aes(x=gradient, y=avg, ymin=lower, ymax=upper, fill=season)) +  geom_pointrange( position=position_dodge(width=0.4), color = rep(c("Grey50","Black"),7), size=1)+ guides(fill = "none") +theme_classic() + scale_fill_manual(values = c("Black","Grey50"))+ scale_x_discrete(limits=c("Panoche","Cuyama","Tejon","Barstow","hwy40","Sheephole","Tecopa")) + scale_y_continuous(expand = c(0, 0))
q

#precipitation
precip <- aggregate(data$Precip, by=list(data$season,data$Gradient), sum)
colnames(precip) <- c("season","Gradient","Precip")

p <-ggplot(precip, aes(Gradient, Precip)) +geom_bar(stat = "identity", aes(fill = season), position = "dodge")+ guides(fill = "none") +theme_classic() + scale_fill_manual(values = c("Black","Grey50"))+ scale_x_discrete(limits=c("Panoche","Cuyama","Tejon","Barstow","hwy40","Sheephole","Tecopa")) + scale_y_continuous(expand = c(0, 0))
p


```

### Microenvironmental differences

We compared temperature and relative humidity between shrub and open microsites among all sites along the regional gradient
```{r echo=FALSE, warning=FALSE, message=FALSE, fig.width=18, fig.height=8, comment=NA}
HOBO.data <- read.csv("data/ERG.HOBOdata.2016.csv")
sites <- as.character(unique(HOBO.data$Site))
psuedograd <- c(2,4,5,1,6,7,3)

for(i in 1:7){
  HOBO.data[grep(sites[i], as.character(HOBO.data$Site)), "gradient"] <- psuedograd[i]
}

## daily means
day.mean <- aggregate(HOBO.data, by=list(day=HOBO.data$Day, micro=HOBO.data$Microsite, site=HOBO.data$Site), mean)

## summarize daily means across sites
means <- day.mean %>% group_by(micro, gradient) %>% summarize(temp=mean(Temp),rh=mean(RH),temp.se=se(Temp),rh.se=se(RH))
means <- data.frame(means)

par(mar=c(4.5,4.5,.5,.5))

par(mfrow=c(1,2))
## plot temperature
plot(c(1:7)-0.1, means[means$micro=="Shrub","temp"], pch=19, ylim=c(5,15), xlab="", xaxt="n", ylab="temperature (CÂ°)", cex.axis=1.3, cex.lab=1.5, cex=1.5, xlim=c(0.7,7.3))
axis(1, c(1:7), unique(HOBO.data$Site), cex.axis=1.3)
error.bar(c(1:7)-0.1, means[means$micro=="Shrub","temp"],means[means$micro=="Shrub","temp.se"]*2, lwd=2)
error.bar(c(1:7)+0.1, means[means$micro=="Open","temp"],means[means$micro=="Open","temp.se"]*2, lwd=2)
points(c(1:7)+0.1, means[means$micro=="Open","temp"], pch=21, bg="White", cex=1.5)

## plot relative humidity
plot(c(1:7)-0.1, means[means$micro=="Shrub","rh"], pch=19, ylim=c(30,100), xlab="", xaxt="n", ylab="relative humidity (%)", cex.axis=1.3, cex.lab=1.5, cex=1.5, xlim=c(0.7,7.3))
axis(1, c(1:7), unique(HOBO.data$Site), cex.axis=1.3)
error.bar(c(1:7)-0.1, means[means$micro=="Shrub","rh"],means[means$micro=="Shrub","rh.se"]*2, lwd=2)
error.bar(c(1:7)+0.1, means[means$micro=="Open","rh"],means[means$micro=="Open","rh.se"]*2, lwd=2)
points( c(1:7)+0.1, means[means$micro=="Open","rh"], pch=21, bg="White", cex=1.5)
legend(5.8,100, c("shrub","open"), pch=21, pt.bg=c("black","white"), bty="n", cex=2)

## stats for temperature
day.mean[,"gradient"] <- as.factor(day.mean$gradient)
fit1 <- aov(log(Temp) ~ micro * gradient, data=day.mean)
shapiro.test(fit1$residuals) ## check normality
summary(fit1)

## stats for relative humidity
fit2 <- glm(RH/100 ~ micro * gradient, data=day.mean, family=binomial)
anova(fit2, test="Chisq")

## stats for soil moisture
census2016 <- read.csv("Data/ERG.census2016.csv")

m.swc <- glm(swc ~ Site * Microsite, data=subset(census2016, census=="end" & Site != "TejonRanch" & swc>0), family="Gamma")
anova(m.swc, test="F")
```

### Site PCA

### site level means
```{r warning=FALSE, message=FALSE, fig.width=8, fig.height=8}
## Obtain mean weather variables for each site
weather <- read.csv("Data/ERG.weather.2016.csv")

weather.mean <- weather %>% group_by(gradient,site) %>% summarise_each(funs(mean))
weather.mean <- data.frame(weather.mean)
## extract key variables
weather.vars <- weather.mean[,c("site","gradient","wind.mean","temp.min","temp.max","humidity.mean","precipitation")]

## Obtain mean nutrient variables for each site
nutrients <- read.csv("Data/ERG.soilnutrients.csv")
nutrients.mean <- nutrients %>% group_by(gradient,site) %>% summarise_each(funs(mean))
nutrients.vars <- data.frame(nutrients.mean)

## Obtain mean shrub traits for each site
shrubs <- read.csv("Data/ERG.shrub.csv")
shrubs <- subset(shrubs, Microsite=="shrub")
shrubs.mean <- shrubs %>% group_by(Gradient,Site) %>% summarise_each(funs(mean))
shrubs.mean <- data.frame(shrubs.mean)
shrubs.vars <- shrubs.mean[,c("Site","Gradient","volume","canopy","Dx","DxEph","Compaction")] 

##combine nutrients, weather, and shrub traits

site.vars <- data.frame(weather.vars[,3:7],nutrients.vars[,5:7])
row.names(site.vars) <- weather.vars[,1]

## PCA of site characteristics

pca1 <- prcomp(log(site.vars))
plot(pca1)
biplot(pca1)

## PCA of shrub characteristics

row.names(shrubs.vars) <- shrubs.vars[,1]
pca2 <- prcomp(log(shrubs.vars[,3:7]))
plot(pca2)
biplot(pca2)
```


### Differences from Nutrient content
```{r}
## Nitrogen difference between shrub and sites
m.nit <- aov(log(N) ~ site * microsite, data=nutrients)
summary(m.nit)
TukeyHSD(m.nit, "microsite")

## Potassium difference between shrub and sites
m.pot <- aov(log(K) ~ site * microsite, data=nutrients)
summary(m.pot)
TukeyHSD(m.pot, "microsite")

## Phosphorus difference between shrub and sites
m.pho <- aov(log(P) ~ site * microsite, data=nutrients)
summary(m.pho)
TukeyHSD(m.pho, "microsite")
```

### annual plant community repsonse

```{r warning=FALSE, message=FALSE}

census2016 <- read.csv("Data/ERG.census2016.csv")

## run full model for phyto biomass
m1 <- aov(log(phyto.biomass)~ Site * Microsite * Nutrient, data=subset(census2016, census=="end" & phyto.biomass>0))
summary(m1)
TukeyHSD(m1, "Microsite")

## run model but with abundance
m2 <- glm.nb(abundance~ Site * Microsite * Nutrient, data=subset(census2016, census=="end" & phyto.biomass>0))
anova(m2, test="Chisq")

## repeat for ambient community biomass

ambient2016 <- read.csv("Data/ERG.community2016.csv")

m3 <- aov(log(Biomass)~ Site * Microsite, data=subset(ambient2016,Biomass>0))
summary(m3)
TukeyHSD(m1, "Microsite")

## site composition of plants

data <- ambient2016[,12:42]
data[is.na(data)] <- 0



### RDA

##collect environmental variables for site
nutrients <- read.csv("Data/ERG.soilnutrients.csv")
nutrients.mean <- nutrients %>% group_by(gradient,site, microsite) %>% summarise_each(funs(mean))
nutrients.vars <- data.frame(nutrients.mean)

## minimum explanation of variables
ambient2016[is.na(ambient2016)] <- 0
community <- ambient2016 %>% group_by(Gradient,Site, Microsite) %>% summarise_each(funs(sum))
community <- data.frame(community)

end.census <- subset(census2016, census=="end")
end.census  <- end.census  %>% group_by(Gradient,Site, Microsite) %>% summarise_each(funs(mean))
end.census<- data.frame(end.census)

## daily means
day.mean <- aggregate(HOBO.data, by=list(day=HOBO.data$Day, micro=HOBO.data$Microsite, site=HOBO.data$Site), mean)

## summarize daily means across sites
means <- day.mean %>% group_by(gradient, micro) %>% summarize(temp=mean(Temp),rh=mean(RH),temp.se=se(Temp),rh.se=se(RH))
means <- data.frame(means)


envs <- data.frame(swc=end.census[,"swc"],nutrients.vars[,c("N","P","K")], means[,c("temp","rh")])

## hellinger transformation
community.trans <- decostand(community[,12:42], "hellinger")

## rda with environmental variables
rda1 <- rda(community.trans, envs)
anova(rda1)
(R2adj <- RsquareAdj(rda1)$adj.r.squared) ## 25.7% of variation explained


## build byplot manually
par(mar=c(4.5,4.5,0.5,0.5))
plot(rda1, type="n", xlim=c(-1,1))

with(community, levels(Site))

spp.priority <- colSums(community[,12:42])

colvec <- c("blue","dodgerblue3","cyan","yellow2","orange","tomato","red2")
with(community, points(rda1, display = "sites", col = "black", pch = c(21,22), bg = colvec[Site]))
orditorp(rda1, display = "species", cex = 0.7, col = "darkred", priority=spp.priority, air=1,)
text(rda1,  display = "bp", col = "blue", cex = 0.8) 
legend("bottomright", pch=c(21), legend=community$Site[community$Microsite=="shrub"], pt.bg=colvec, cex=1)

## check variable explanation
vif.cca(rda1)

v.clim <- cbind(envs[,c("temp","rh")])
v.nut <- cbind(envs[,c("N","P","K")])
v.swc <- envs[,"swc"]

x <- varpart(community.trans,v.clim,v.nut,v.swc)

showvarparts(3)
```


Difference in effect size

```{r warning=FALSE, fig.width=9}

library(bootES)

effect.cal <- function(x){ bootES(x, R=999, data.col="Biomass", group.col="Microsite", contrast=c(shrub=1,open=-1), effect.type=c("cohens.d"))}

effect.site <- by(subset(ambient2016, Site != "Barstow"), ambient2016$Site[ambient2016$Site != "Barstow"], FUN=effect.cal)

site.summary <- rbind(summary(effect.site$Panoche),summary(effect.site$Cuyama),summary(effect.site$TejonRanch),data.frame(stat=0,ci.low=0,ci.high=0,bias=0,std.error=0),summary(effect.site$MojavePreserve),summary(effect.site$SheepholeValley),summary(effect.site$Tecopa)) 


par(mar=c(4.5,4.5,.5,.5))
plot(c(1:7),site.summary[,"stat"], xlim=c(0.5,7.5), ylim=c(-1,3), pch=19, cex=1.4, ylab="Hedge's G", xlab="", xaxt="n")
arrows(c(1:7),site.summary[,"ci.high"],c(1:7),site.summary[,"ci.low"], angle=90, code=3, length=0, lwd=2)
abline(h=0, lty=2, lwd=2)
axis(1, c(1:7), labels=site.names, cex.axis=1)

## phytometer

effect.cal <- function(x){ bootES(x, R=999, data.col="phyto.biomass", group.col="Microsite", contrast=c(shrub=1,open=-1), effect.type=c("cohens.d"))}

census2016 <- subset(census2016, census=="end")

effect.site <- by(subset(census2016, Site != "Barstow"), census2016$Site[census2016$Site != "Barstow"], FUN=effect.cal)

site.summary <- rbind(summary(effect.site$Panoche),summary(effect.site$Cuyama),summary(effect.site$TejonRanch),data.frame(stat=0,ci.low=0,ci.high=0,bias=0,std.error=0),summary(effect.site$MojavePreserve),summary(effect.site$SheepholeValley),summary(effect.site$Tecopa)) 


par(mar=c(4.5,4.5,.5,.5))
plot(c(1:7),site.summary[,"stat"], xlim=c(0.5,7.5), ylim=c(-1,3), pch=19, cex=1.4, ylab="Hedge's G", xlab="", xaxt="n")
arrows(c(1:7),site.summary[,"ci.high"],c(1:7),site.summary[,"ci.low"], angle=90, code=3, length=0, lwd=2)
abline(h=0, lty=2, lwd=2)
axis(1, c(1:7), labels=site.names, cex.axis=1)